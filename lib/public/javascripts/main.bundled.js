"use strict";var helpers={},templates={},models={},collections={},app={},views={},routing={};helpers.common={sortNumber:function(e,t){return e-t},htmlDecode:function(e){var t=document.createElement("div");return t.innerHTML=e,t.childNodes[0].nodeValue},toUserTimezone:function(e){var t=moment(e),i=t.tz(pageData.timezone);return i},conciseDate:function(e){var t=helpers.common.toUserTimezone(e),i=t.format("MM-DD-YY");return i},addCommas:function(e){return e||0===e?e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","):(console.log("Warning: Expected string, found",e),"")},prettyDatestamp:function(e){var t=helpers.common.toUserTimezone(e),i=t.format("M/D/YYYY, h:mm a");return i},toTitleCase:function(e){return e.charAt(0).toUpperCase()+e.slice(1,e.length)},boolToStr:function(e,t){var i;return i=e?t:""}},helpers.modelsAndCollections={toggle:function(e){this.set(e,!this.get(e))},setBoolByIds:function(e,t,i,a){i=i.split("+").map(function(e){return+e}),i.forEach(function(i){var s={};s[t]=i,this.where(s).length&&this.where(s)[0].set(e,a)},this)},addTagsFromId:function(e){return e.forEach(function(e){e.subject_tags=$.extend(!0,[],e.subject_tags.map(function(e){return pageData.org.subject_tags.filter(function(t){return t.id==e})[0]})),e.events.forEach(function(e){e.impact_tags=$.extend(!0,[],e.impact_tags.map(function(e){return pageData.org.impact_tags.filter(function(t){return t.id==e})[0]}))})}),e},metadata:function(e,t){return this.metadataHash||(this.metadataHash={}),void 0===t?this.metadataHash[e]:void(this.metadataHash[e]=t)}},helpers.templates={addCommas:helpers.common.addCommas,autolink:function(e){return Autolinker.link(e)},toLowerCase:function(e){return e.toLowerCase()},toTitleCase:helpers.common.toTitleCase,serviceFromSousChef:function(e){return e.split("-")[0]},methodFromSousChef:function(e){return this.prettyName(e.split("-")[1])},alertSourceIdToSousChef:function(e){return e.split(":")[0]},alertSourceIdToService:function(e){var t=helpers.templates.alertSourceIdToSousChef(e);return helpers.templates.serviceFromSousChef(t)},getRecipeFromId:function(e){null===e&&(e=-1);var t,i=collections.recipes.instance.findWhere({id:e});return i?t=i.toJSON():(console.log("ERROR, could not find recipe of id",e,"in",collections.recipes.instance.models),console.log(i)),t},prettyPrintSource:function(e){return e=e.replace(/-/g," ").replace(/_/g," "),helpers.templates.toTitleCase(e)},prettyDateTimeFormat:"MMM D, YYYY, h:mm a",prettyDate:function(e){var t=helpers.common.toUserTimezone(e),i=t.format("MMM D, YYYY");return i},prettyDatestamp:helpers.common.prettyDatestamp,conciseDate:helpers.common.conciseDate,fullIsoDate:function(e){var t=helpers.common.toUserTimezone(e),i=t.format();return i},formatEnabled:function(e){return e?"Recipe is active":"Recipe not active"},formatDefaultEventEnabled:function(e){return e?"Enabled":"Disabled"},getAssociatedItems:function(e,t,i){return i=pageData[i],_.filter(i,function(i){return i[t]==e})},prettyName:function(e){return e=e.replace(/_/g," "),e.charAt(0).toUpperCase()+e.slice(1)},escapeQuotes:function(e){return e?"string"!=typeof e?e:e.replace(/"/g,"&quot;"):!1},displayRecipeParams:function(e){var t=helpers.templates.getRecipeFromId(e),i="";return i+=t.name,t.options&&t.options.search_query&&(i+=",<br/>"+t.options.search_query),i},htmlDecode:helpers.common.htmlDecode,boolToStr:helpers.common.boolToStr,getHeadlineFromArticleId:function(e){var t,i=_.findWhere(pageData.articleSkeletons,{id:e});return t=i?i.title:"Article headline no longer available"},extractDomain:function(e){var t=/^http/;t.test(e)||(e="http://"+e);var i=e.match(/^https?\:\/\/([^\/?#]+)(?:[\/?#]|$)/i)[0].replace("www.","").replace("://","").replace(/https?/,"").replace("/","");return i},handleEventCounts:function(e,t,i){var a="";return i&&t?a=i.pending+" pending":i&&"unscheduled"==t?a="Not scheduled,"+i.pending+" pending":!e&&t?a="Scheduled to run, 0 pending":i||"unscheduled"!=t||(a="Not scheduled. 0 pending"),a},articles:{prettyMetricName:function(e,t){var i={subject_tags:"subj.",impact_tags:"imp."};return t&&i[e]&&(e=i[e]),e=e.replace(/_/g," ").replace("ga ","GA ").replace("facebook","FB"),e.charAt(0).toUpperCase()+e.slice(1)},isActiveMetric:function(e,t){var i=t.replace("-metrics.",""),a=i==e?"active":"";return a},htmlDecode:helpers.common.htmlDecode,prettyDatestamp:helpers.common.prettyDatestamp,conciseDate:helpers.common.conciseDate,prettyMetricValue:function(e,t){return"avg"==t&&(e=e.toFixed(2)),helpers.common.addCommas(e)},convertLineBreaksToHtml:function(e){return e=e||"",e.replace(/\n/g,"<br/>")},toTitleCase:helpers.common.toTitleCase,boolToStr:helpers.common.boolToStr}},models.alert={Model:Backbone.Model.extend({urlRoot:"api/_VERSION/events"})},models.article_detailed={Model:Backbone.Model.extend({getTimeSeriesStats:function(){var e,t=this.get("timeseries_stats"),i=["pageviews","twitter_count","facebook_share_count"];return e=t.map(function(e){var t=_.keys(e),a={};return i.forEach(function(i){var s=_.contains(t,i);s&&(a.timestamp=e.timestamp,a[i]=e[i])}),a})}})},models.article_summary={Model:Backbone.Model.extend({defaults:{active_selected:!1,selected_for_compare:!1,selected_for_detail:!1},toggle:helpers.modelsAndCollections.toggle,parse:function(e){var t=this.addInfo(e);return t},addInfo:function(e){return e=this.hydrateTagsInfo(e,pageData.tags,["subject_tag_ids","impact_tag_ids"]),e=this.nestTags(e),e=this.addTagInputOptions(e)},addTagInputOptions:function(e){var t=collections.subject_tags.instance.models.map(function(t){var i=t.clone();return i.urlRoot="api/_VERSION/content/"+e.id+"/tags/",i});return e.subject_tag_input_options=t,e},hydrateTagsInfo:function(e,t,i){return i.forEach(function(i){if(e[i]){var a=i.replace("_ids","s_full");e[a]=e[i].map(function(e){var a=i.replace("_tag_ids","");return _.findWhere(t[a],{id:e})}).sort(function(e,t){return e.name.localeCompare(t.name)})}var s=_.chain(e.impact_tags_full).pluck("category").uniq().map(function(e){var t={};return t.name=e,t.color=pageData.attributeColorLookup[e],t}).value(),n=_.chain(e.impact_tags_full).pluck("level").uniq().map(function(e){var t={};return t.name=e,t.color=pageData.attributeColorLookup[e],t}).value();e.impact_tag_categories=_.sortBy(s,"name"),e.impact_tag_levels=_.sortBy(n,"name")}),e},nestTags:function(e){var t=[],i=3;if(e.subject_tags_full)for(var a=0;a<e.subject_tags_full.length;a+=i)t.push(e.subject_tags_full.slice(a,a+i));e.subject_tags_grouped=t;var s=[];return e.impact_tags_full&&(s=d3.nest().key(function(e){return e.category}).key(function(e){return e.name}).rollup(function(e){return{name:e[0].name,color:e[0].color,category:e[0].category,level:e[0].level,count:e.length}}).entries(e.impact_tags_full)),e.impact_tags_grouped=s,e}})},models.filters={Model:Backbone.Model.extend({metadata:helpers.modelsAndCollections.metadata,initialize:function(){return this.on("filter",this.checkChanged),this.assembleQueryParams(),this},checkChanged:function(){var e=this.metadata("previousParams"),t=JSON.stringify(this.assembleQueryParams(!0));return e!=t&&this.trigger("hasChanged"),this},assembleQueryParams:function(e){var t=$.extend(!0,{},this.toJSON());return _.each(t,function(e,i){_.isArray(e)&&(t[i]=e.join(","))}),t.sort_by&&(t.sort=t.sort_by,delete t.sort_by),e||this.metadata("previousParams",JSON.stringify(t)),t}})},models.event={Model:Backbone.Model.extend({urlRoot:"/api/_VERSION/events",parse:function(e){var t=this.hydrateTags(e);return t},hydrateTags:function(e){var t=e.tag_ids.map(function(e){return collections.impact_tags.instance.findWhere({id:e})});return e.impact_tags_full=t,e}})},models.generic={Model:Backbone.Model.extend({})},models.impact_tag={Model:Backbone.Model.extend({defaults:{type:"impact",color:"#6699cc",active:!1,category:null,level:null},toggle:helpers.modelsAndCollections.toggle})},models.new_article={Model:Backbone.Model.extend({urlRoot:"/api/articles"})},models.org={Model:Backbone.Model.extend({urlRoot:"/api/_VERSION/settings"})},models.recipe={Model:Backbone.Model.extend({toggle:helpers.modelsAndCollections.toggle,defaults:{viewing:!1,enabled:!0},initialize:function(e){var t=_.chain(e.options).keys().filter(function(t){var i=_.clone(e.options[t]);return _.isObject(i)&&i.input_options&&delete i.input_options,/^set_event_/.test(t)&&!_.isEmpty(i)}).value(),i=t.length?!0:!1;this.set("set_default_event",i)}})},models.recipe_creator={Model:Backbone.Model.extend({urlRoot:"/api/_VERSION/recipes"})},models.setting={Model:Backbone.Model.extend({})},models.sous_chef={Model:Backbone.Model.extend({toggle:helpers.modelsAndCollections.toggle})},models.subject_tag={Model:Backbone.Model.extend({toggle:helpers.modelsAndCollections.toggle,defaults:{type:"subject",color:"#1f78b4"}})},models.user_setting={Model:Backbone.Model.extend({url:"api/_VERSION/me"})},collections.active_alerts={instance:null,Collection:Backbone.Collection.extend({model:models.alert.Model,metadata:helpers.modelsAndCollections.metadata,url:"api/_VERSION/events",comparator:function(e){return e.created}})},collections.article_comparisons={instance:null,Collection:Backbone.Collection.extend({model:models.article_summary.Model,metadata:helpers.modelsAndCollections.metadata,url:"api/_VERSION/content?facets=subject_tags,impact_tags,categories,levels&incl_body=false",initialize:function(){return this.metadata("operation","mean"),this.metadata("group","all"),this.metadata("max","per_97_5"),this},parse:function(e){return e.content_items},set:function(){Backbone.Collection.prototype.set.apply(this,arguments),this.updateHash()},remove:function(){Backbone.Collection.prototype.remove.apply(this,arguments),this.updateHash()},add:function(){Backbone.Collection.prototype.add.apply(this,arguments),this.updateHash()},sort:function(e){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");return e=e||{},_.isString(this.comparator)||1===this.comparator.length?this.models=this.sortBy(this.comparator,this):this.models.sort(_.bind(this.comparator,this)),console.log("id list from comparison sort",this.pluck("id")),e.silent||this.trigger("sort",this,e),this.updateHash(),this},setComparator:function(e){var t=this.metadata("sort_ascending"),i={};i.text=function(t){var i=t.get(e);return i},i.date=i.text,i.metric=function(i){var a=i.get("metrics")[e];return t||(a=-1*a),a},i.bars=function(i){var a=i.get(e+"_full").length;return t||(a=-1*a),a};var a=_.findWhere(collections.dimensions.instance.getSelectDimensions(),{name:e}).kind;return this.comparator=i[a],"text"!=a&&"date"!=a||t||(this.comparator=this.reverseSortBy(this.comparator)),this},reverseSortBy:function(e){return function(t,i){var a=e(t),s=e(i);return void 0===a?-1:void 0===s?1:s>a?1:a>s?-1:0}},updateHash:function(){var e=this.metadata("sort_by"),t=this.metadata("sort_ascending"),i="?sort="+e+"&asc="+t;this.hash=this.pluck("id").join("+")+i},getHash:function(){return this.hash},redrawMarkers:function(){this.trigger("resetMetricHeaders"),this.models.forEach(function(e){e.trigger("redrawMarker")})}})},collections.article_detailed={instance:null,Collection:Backbone.Collection.extend({model:models.article_detailed.Model,metadata:helpers.modelsAndCollections.metadata,set:function(){Backbone.Collection.prototype.set.apply(this,arguments),this.updateHash()},updateHash:function(){this.length&&(this.hash=this.first().get("id"))},getHash:function(){return this.hash},addLevelColors:function(e){return e.map(function(e){var t=pageData.attributeColorLookup[e.level];return e.color=t,e})}})},collections.article_detailed_events={Collection:Backbone.Collection.extend({model:models.event.Model,metadata:helpers.modelsAndCollections.metadata,url:"api/_VERSION/events?facets=tags,categories,levels&status=approved&per_page=10&creates=events",parse:function(e){return this.metadata("pagination",e.pagination),this.metadata("total",e.total),models.event_tag_facets.set(e.facets),e.events},comparator:function(e){return e.created}})},collections.article_detailed_impact_tag_attributes={categories_instance:null,levels_instance:null,Collection:Backbone.Collection.extend({model:models.impact_tag.Model,metadata:helpers.modelsAndCollections.metadata})},collections.article_detailed_impact_tags={instance:null,Collection:Backbone.Collection.extend({model:models.impact_tag.Model,set:function(){Backbone.Collection.prototype.remove.call(this,this.models),Backbone.Collection.prototype.set.apply(this,arguments)}})},collections.article_detailed_subject_tags={instance:null,Collection:Backbone.Collection.extend({model:models.subject_tag.Model})},collections.article_detailed_timeseries={categories_instance:null,levels_instance:null,Collection:Backbone.Collection.extend({model:models.event.Model,metadata:helpers.modelsAndCollections.metadata,url:"TK"})},collections.article_summaries={instance:null,Collection:Backbone.Collection.extend({model:models.article_summary.Model,metadata:helpers.modelsAndCollections.metadata,url:"api/_VERSION/content?facets=subject_tags,impact_tags,categories,levels&incl_body=false",parse:function(e){return this.metadata("pagination",e.pagination),this.metadata("total",e.total),models.tag_facets.set(e.facets),e.content_items}})},collections.articles_detailed={instance:null,Collection:Backbone.Collection.extend({model:models.article_detailed.Model})},collections.dimensions={instance:null,Collection:Backbone.Collection.extend({metadata:helpers.modelsAndCollections.metadata,initialize:function(){var e=[{name:"title",kind:"text"},{name:"created",kind:"date"},{name:"ga_pageviews",kind:"metric"},{name:"twitter_shares",kind:"metric"},{name:"facebook_likes",kind:"metric"},{name:"facebook_shares",kind:"metric"},{name:"facebook_comments",kind:"metric"},{name:"subject_tags",kind:"bars"},{name:"impact_tags",kind:"bars"}];this.metadata("selects",e)},cloneMetrics:function(e){var t=[];return this.metadata("selects").forEach(function(i){var a;("metric"==i.kind||e)&&(a=_.clone(i),t.push(a))}),t},getSelectDimensions:function(){var e=this.cloneMetrics(!0),t=[],i=this;return e.forEach(function(e){var a,s=e.name,n=i.findWhere({name:s});n&&(a=_.clone(n.toJSON()),_.extend(a,e),t.push(a))}),t},getSelectsForIsotope:function(){var e=this.cloneMetrics(!0),t={};return e.forEach(function(e){var i="";("metric"==e.kind||"impact_tags"==e.name)&&(i=" parseFloat"),t[e.name]="[data-"+e.name+"]"+i}),t}})},collections.impact_tag_attributes={categories_instance:null,levels_instance:null,Collection:Backbone.Collection.extend({model:models.impact_tag.Model,metadata:helpers.modelsAndCollections.metadata})},collections.impact_tags={instance:null,Collection:Backbone.Collection.extend({model:models.impact_tag.Model,url:"/api/tags/impact",metadata:helpers.modelsAndCollections.metadata,url:function(){return"/api/_VERSION/tags"}})},collections.loaded_alerts={recipe_all_instance:null,Collection:Backbone.Collection.extend({model:models.alert.Model,metadata:helpers.modelsAndCollections.metadata,url:"api/_VERSION/events?status=pending&creates=events",parse:function(e){return this.metadata("pagination",e.pagination),this.metadata("total",e.total),e.events}})},collections.po={sorts:{}},collections.recipes={instance:null,schemas_instance:null,Collection:Backbone.Collection.extend({url:"/api/_VERSION/recipes",model:models.recipe.Model,setBoolByIds:helpers.modelsAndCollections.setBoolByIds})},collections.article_rss_feeds={instance:null,Collection:Backbone.Collection.extend({metadata:helpers.modelsAndCollections.metadata,url:"api/_VERSION/alerts"})},collections.settings={instance:null,Collection:Backbone.Collection.extend({model:models.setting.Model,metadata:helpers.modelsAndCollections.metadata,url:"api/_VERSION/settings"})},collections.sous_chefs={instance:null,schemas_instance:null,Collection:Backbone.Collection.extend({url:"/api/_VERSION/sous-chefs",model:models.sous_chef.Model,setBoolByIds:helpers.modelsAndCollections.setBoolByIds})},collections.subject_tags={instance:null,Collection:Backbone.Collection.extend({model:models.subject_tag.Model,metadata:helpers.modelsAndCollections.metadata,url:function(){return"/api/_VERSION/tags"}})},collections.user_settings={instance:null,Collection:Backbone.Collection.extend({model:models.user_setting.Model,metadata:helpers.modelsAndCollections.metadata,url:"api/_VERSION/me"})},app.ApprovalRiver=Backbone.View.extend({el:"#main-wrapper",events:{"click .scroll-to":"scrollTo","click .load-more":"loadMoreAlerts"},initialize:function(){this._subviews=[],this.$drawer=$("#drawer"),this.$content=$("#content"),this.$divisionSwitcher=$(".division-switcher"),this.setLoading(this.$content,"true"),this.listenTo(models.section_mode,"change:mode",this.sectionMode.update),this.listenTo(collections.active_alerts.instance,"add",this.alerts.add),this.listenTo(collections.active_alerts.instance,"remove",this.alerts.remove),this.render()},setLoading:function(e,t){e.attr("data-loading",t)},saveHash:function(e){routing.router.navigate(e)},sectionMode:{update:function(e,t){return t=t||e.get("mode"),this.setLoading(this.$drawer,"true"),collections.active_alerts.instance.reset(null),this.killAllSubviews(),this.$content.find(".placeholder").remove(),this.sectionMode[t].call(this),this.saveHash(t),this},"my-recipes":function(){var e=this.$drawer,t=e.find("#drawer-pointers-container"),i=this.$content,a=$("#recipes");e.attr("data-mode","my-recipes");var s=collections.recipes.instance.length>1,n=new views.ShowAllRecipes({}),r=n.render(s).el;this._subviews.push(n),app.instance.pause_init||n.setState(),this.show_all_view=n,t.html(r);var o=collections.recipes.instance.findWhere({id:-1}),l=new views.RecipeDrawerStatic({model:o}),c=l.render().el;return this._subviews.push(l),a.append(c),s?collections.recipes.instance.each(function(e){if(-1!==e.id){var t=new views.RecipeDrawer({model:e}),i=t.render().el;this._subviews.push(t),a.append(i)}},this):i.html('<div class="placeholder">You don\'t have any recipes. Click <a href="/approval-river#create">create</a> to make some. &mdash; <em>Merlynne</em></div>'),this.setLoading(this.$drawer,"false"),this},create:function(){var e=this.$drawer,t=e.find("#drawer-pointers-container"),i=this.$content,a=$("#recipes");this.clearLoadMoreButton();var s=templates.drawerCreatePrep;return t.html(s),collections.sous_chefs.instance.each(function(e){var t=new views.SousChefDrawerItem({model:e}),i=t.render().el;this._subviews.push(t),a.append(i)},this),collections.sous_chefs.instance.each(function(e){var t=new views.SousChefForm({model:e}),a=t.render().el;this._subviews.push(t),i.append(a)},this),this.setLoading(this.$content,"false"),this}},alerts:{add:function(e){var t,i;return t=new views.Alert({model:e}),i=t.render().el,this.setLoading(this.$content,"false"),this._subviews.push(t),this.$content.append(i),this},remove:function(e){return e.set("destroy","remove"),this}},render:function(){return new views.DivisionSwitcher({model:models.section_mode,el:this.$divisionSwitcher}),this},content:{setActiveAlertsPerRecipe:function(e){this.clearLoadMoreButton.call(this),this.setLoading(this.$content,"true");{var t=this;collections.active_alerts.instance.metadata("page_size")}collections.active_alerts.instance.metadata("recipe_id",e),collections.loaded_alerts["recipe_"+e+"_instance"]||(collections.loaded_alerts["recipe_"+e+"_instance"]=new collections.loaded_alerts.Collection([]));var i,a=collections.loaded_alerts["recipe_"+e+"_instance"],s=(a.metadata("pagination"),{remove:!1,data:{},success:function(i,a,s){collections.active_alerts.instance.set(i.models),t.setLoadMoreButton.call(t,e)},error:function(e,t){console.log("Error fetching alerts for recipe",e,t)}});"all"!=e&&(-1===e?i="manual":(i="recipe",s.data.recipe_ids=e),s.data.provenance=i);var n,r=a.metadata("total");r||0===r||(n=collections.recipes.instance.findWhere({id:e}).get("event_counts"),r=n?n.pending:0);var o=a.models;return o.forEach(function(e){e.set("destroy",null)}),r?o.length?(t.$content.find(".placeholder").remove(),collections.active_alerts.instance.set(o),t.setLoadMoreButton.call(app.instance,e)):(t.$content.find(".placeholder").remove(),collections.active_alerts.instance.set([]),a.fetch(s)):(t.$content.html("<div class=\"placeholder\">This recipe doesn't have any pending alerts. I'll let you know here when I find some!<br/>&mdash; <em>Merlynne</em></div>"),collections.active_alerts.instance.set(o),this.setLoading(this.$content,"false")),this}},loadMoreAlerts:function(e){app.helpers.gifizeLoadMoreButton($(e.currentTarget));var t,i=app.instance,a=collections.active_alerts.instance.metadata("recipe_id"),s=collections.loaded_alerts["recipe_"+a+"_instance"],n=s.metadata("pagination"),r=n.page,o={remove:!1,data:{page:r+1},success:function(e,t,s){collections.active_alerts.instance.add(t.events),i.setLoadMoreButton.call(i,a)},error:function(e,t){console.log("Error fetching more alerts detail",t)}};return"all"!=a&&(-1===a?t="manual":(t="recipe",o.data.recipe_ids=a),o.data.provenance=t),s.fetch(o),this},clearLoadMoreButton:function(){this.$content.find(".load-more").remove()},setLoadMoreButton:function(e){var t;this.clearLoadMoreButton();var i,a=collections.loaded_alerts["recipe_"+e+"_instance"],s=a.metadata("pagination"),n=s.page,r=s.per_page,o=s.total_pages,l=a.length,c=a.metadata("total"),d=o>n,h=c-l,u=_.min([h,r]);return d&&(t=$('<button class="load-more"></button>'),i="Showing "+l+" out of "+c+". Load "+u+" more...",t.html(i).appendTo(this.$content)),this},scrollTo:function(e){var t=$(e.currentTarget).attr("data-destination"),i=10;this.$content.animate({scrollTop:this.$content.scrollTop()+$("#"+t+"-recipe").position().top-parseFloat(this.$content.css("padding-top"))-i},200)}}),app.Articles=Backbone.View.extend({el:"#main-wrapper",events:{"click .add-to-comparison":"addToComparison","click .option-title .show-hide":"showHideList","change .toggle-all":"toggleAllDrawer","click #alter-comparison-marker":"updateComparisonMarker",'click .load-more[data-which="article-summaries"]':"moreSummaryArticles","click .go-to-detail":"goToDetail"},initialize:function(){this._subviews=[],this.$subjectTagList=$('.option-container[data-type="subject-tags"] .tag-list'),this.$impactTagCategoriesList=$('.option-container[data-type="categories"] .tag-list'),this.$impactTagLevelsList=$('.option-container[data-type="levels"] .tag-list'),this.$impactTagList=$('.option-container[data-type="impact-tags"] .tag-list'),this.tag_list_els={subject_tags:this.$subjectTagList.parent(),categories:this.$impactTagCategoriesList.parent(),levels:this.$impactTagLevelsList.parent(),impact_tags:this.$impactTagList.parent()},this.$articleList=$("#article-list"),this.$drawer=$("#drawer"),this.$content=$("#content"),this.$divisionSwitcher=$(".division-switcher"),this.$drawerPointersCntnr=$("#drawer-pointers-container"),this.$articleTitleSearcher=$("#article-title-searcher"),this.$dateRangeSearcher=$("#date-range-searcher"),this.$articleDrawerSorter=$("#article-drawer-sorter"),this.$addArticle=$("#add-article"),this.isotopeCntnr=".rows",this.isotopeChild=".article-detail-row-wrapper",this.listenTo(models.section_mode,"change:mode",this.sectionMode.update),this.listenTo(collections.article_summaries.instance,"add",this.drawer.add),this.listenTo(collections.article_summaries.instance,"remove",this.drawer.remove),this.listenTo(collections.article_summaries.instance,"error",this.reportErr),this.listenTo(collections.article_comparisons.instance,"add",this.comparison.add),this.listenTo(collections.article_comparisons.instance,"remove",this.comparison.remove),this.listenTo(collections.article_detailed.instance,"add",this.detail.add),this.listenTo(collections.article_detailed.instance,"remove",this.detail.remove),this.listenTo(collections.article_detailed.instance,"error",this.reportErr),this.listenTo(models.tag_facets,"change",this.updateTagContainerByCounts),this.listenTo(models.content_item_filters,"hasChanged",this.fetchByParameters),this.render();var e=this;this.$content.on("scroll",function(){var t=$(this);e.onScrollTick.call(e,t)})},render:function(){return this.$drawerPointersCntnr.append(templates.drawerPointers),collections.subject_tags.instance.length&&(this.$subjectTagList.html(""),collections.subject_tags.instance.each(function(e){var t=new views.TagSectionNav({model:e});this.$subjectTagList.append(t.render().el)},this)),collections.impact_tags.instance.length&&(this.$impactTagList.html(""),collections.impact_tags.instance.each(function(e){var t=new views.TagSectionNav({model:e});this.$impactTagList.append(t.render().el)},this)),collections.impact_tag_attributes.categories_instance.length&&(this.$impactTagCategoriesList.html(""),collections.impact_tag_attributes.categories_instance.each(function(e){var t=new views.TagSectionNav({model:e});this.$impactTagCategoriesList.append(t.render().el)},this)),collections.impact_tag_attributes.levels_instance.length&&(this.$impactTagLevelsList.html(""),collections.impact_tag_attributes.levels_instance.each(function(e){var t=new views.TagSectionNav({model:e});this.$impactTagLevelsList.append(t.render().el)},this)),collections.article_summaries.instance.each(function(e){var t=new views.ArticleSummaryDrawer({model:e});this.$articleList.append(t.render().el)},this),collections.subject_tags.instance.each(function(e){var t=$("<option></option>").val(e.get("id")).html(e.get("name"));t.appendTo('.alter-comparison-marker[data-which="group"]')}),new views.DivisionSwitcher({model:models.section_mode,el:this.$divisionSwitcher}),new views.ArticleSearcher({el:this.$articleTitleSearcher}),new views.DateRangeSearcher({el:this.$dateRangeSearcher}),new views.ArticleDrawerSorter({el:this.$articleDrawerSorter,collection:collections.dimensions.instance}),this.bakeArticleAdder(),this.updateTagContainerByCounts(),this.setLoading(this.$drawer,"false"),this.$articleCount=this.$drawer.find('.item-text[data-which="article-count"]'),this.setLoadMoreButton(),this},setLoading:function(e,t){e.attr("data-loading",t)},reportErr:function(e,t){var i=t.responseJSON;console.log("ERROR in model:",e),console.log("ERROR message:",i),alert(i.error+" "+i.status_code+": "+i.message)},fetchByParameters:function(e){var t=models.content_item_filters.assembleQueryParams(),i=collections.article_summaries.instance.metadata("pagination").page;return console.log("params",t),e?t.page=i+1:(app.instance.setLoading.call(app.instance,app.instance.$articleList,!0),collections.article_summaries.instance.set([])),collections.article_summaries.instance.fetch({data:t,remove:!1}).then(function(e,t,i){app.instance.setLoading.call(app.instance,app.instance.$articleList,!1),app.instance.setLoadMoreButton.call(app.instance)}),this},sectionMode:{update:function(e,t){return t=t||e.get("mode"),collections.article_comparisons.instance.set([]),collections.article_detailed.instance.set([]),this.sectionMode[t].call(this),collections.article_summaries.instance.each(function(e){var i="selected_for_"+t,a=e.get(i);e.set("active_selected",a)}),this},compare:function(){var e=new views.ArticleComparisonGrid({collection:collections.dimensions.instance});this._subviews.push(e),this.$content.html(e.render().el),this.$listContainer=$("#compare-grid .rows");var t=collections.dimensions.instance.getSelectsForIsotope();app.helpers.isotope.initCntnr.call(this,t);collections.article_comparisons.instance.metadata("sort_by"),collections.article_comparisons.instance.metadata("sort_ascending");this.$drawer.find('.drawer-item-group[data-which="comparison-additions"] input,.drawer-item[data-type="action-item"] button').prop("disabled",!1).parent().removeClass("disabled");var i=(collections.article_comparisons.instance.metadata("sort_by"),collections.article_comparisons.instance.metadata("sort_ascending"));$(".header-el").attr("data-sort-ascending",i);var a,s;return this.pause_init||(console.log("loading comparison models from saved info"),a=this.staged_article_comparison_models||collections.article_summaries.instance.models,s=this.comparison.loadRows(a,this.saveHash),this.staged_article_comparison_models=a),this},detail:function(e){return e=e||this.staged_article_detail,this.$drawer.find('.drawer-item-group[data-which="comparison-additions"] input,.drawer-item[data-type="action-item"] button').prop("disabled",!0).parent().addClass("disabled"),this.detail.loadPage.call(this,e,this.saveHash),this}},toggleAllDrawer:function(e){var t=$(e.currentTarget).find("input").prop("checked"),i=models.section_mode.get("mode"),a="selected_for_"+i;return collections.article_summaries.instance.each(function(e){"compare"==i&&e.set(a,t),e.set("active_selected",t)}),this},drawer:{setActiveArticleSummaries:function(){return collections.article_summaries.instance.set([]),collections.article_summaries.instance.set(current_filtered_set),app.instance.setLoadMoreButton.call(app.instance),app.instance.$drawer.find(".drawer-list-outer").shiftSelectable(),this},add:function(e){var t,i;return t=new views.ArticleSummaryDrawer({model:e}),i=t.render().el,this.$articleList.append(i),this},remove:function(e){return e.trigger("destroy"),this}},addToComparison:function(e){var t,i,a,s=$(e.currentTarget),a=s.attr("data-action"),n=collections.article_summaries.instance.where({selected_for_compare:!0});return"replace"==a?a="set":"add"==a&&(a="add"),collections.article_comparisons.instance[a](n),this.staged_article_comparison_models=collections.article_comparisons.instance.slice(0),t=collections.article_comparisons.instance.metadata("sort_by"),i=collections.article_comparisons.instance.metadata("sort_ascending"),app.helpers.isotope.relayout(t,i),console.log("adding to comparison"),this},comparison:{add:function(e){var t,i;return t=new views.ArticleSummaryRow({model:e,collection:collections.dimensions.instance}),this._subviews.push(t),i=t.render().el,this.$listContainer.append(i),app.helpers.isotope.addItem.call(app.instance,i),this},remove:function(e){return e.trigger("removeFromComparison"),this},loadRows:function(e,t){return collections.article_comparisons.instance.set(e),t(),this}},detail:{add:function(e){var t,i;return t=new views.ArticleDetail({model:e}),this._subviews.push(t),i=t.render().el,this.$content.html(i),t.bakeInteractiveBits(),this},remove:function(e){return e.trigger("destroyDetail"),this},loadPage:function(e,t){var i=collections.article_summaries.instance.findWhere({id:e})||collections.article_summaries.instance.first();i?(i.set("active_selected",!0),i.set("selected_for_detail",!0),collections.article_detailed.instance.set([i]),t(),this.staged_article_detail=e):(console.log("FIGURE OUT FETCHING"),t())}},saveHash:function(){var e=models.section_mode.get("mode"),t={compare:"article_comparisons",detail:"article_detailed"},i=t[e],a=collections[i].instance.getHash();a&&(a="/"+a),console.log("navigating"),routing.router.navigate(e+a)},showHideList:function(e){var t,i=$(e.currentTarget),a="true"==i.attr("data-open"),s=i.parents(".option-container").find(".tag-list"),n=400;a?(s.slideUp(n,"easeOutQuint"),t="Show"):(s.slideDown(n,"easeOutQuint"),t="Hide"),i.attr("data-open",!a).html(t)},moreSummaryArticles:function(e){return app.helpers.gifizeLoadMoreButton($(e.currentTarget)),this.fetchByParameters(!0),this},clearLoadMoreButton:function(){this.$drawer.find(".load-more").remove()},setLoadMoreButton:function(){var e;this.clearLoadMoreButton();var t,i,a=collections.article_summaries.instance,s=a.metadata("pagination"),n=s.page,r=s.per_page,o=s.total_pages,l=a.length,c=a.metadata("total"),d=o>n,h=c-l,u=_.min([h,r]);return t="Showing "+l+" out of "+c,this.$articleCount.html(t),d&&(e=$('<button class="load-more"></button>'),i="Load "+u+" more...",e.html(i).appendTo(this.$articleList)),this},updateComparisonMarker:function(e){var t=$('.alter-comparison-marker[data-which="operation"]').val(),i=$('.alter-comparison-marker[data-which="group"]').val();return collections.article_comparisons.instance.metadata("operation",t),collections.article_comparisons.instance.metadata("group",i),collections.article_comparisons.instance.redrawMarkers(),this},onScrollTick:function(e){var t,i,a=5,s=(e[0].scrollHeight,e.scrollTop()),n=this.$el.find(".sticky");

n.length&&(i=+n.attr("data-offset"),t=s>=i-a?!0:!1,n.toggleClass("stuck",t))},goToDetail:function(e){var t=+$(e.currentTarget).attr("data-id");this.staged_article_detail=t;var i=models.section_mode.get("mode");return"detail"!=i?models.section_mode.set("mode","detail"):(console.log("here",t),this.sectionMode.detail.call(this,t)),this},bakeArticleAdder:function(){var e={},t=new views.AddArticle({defaults:e,el:this.$addArticle[0]});return this._time_picker=t._time_picker,this},toggleModal:function(e){views.helpers.toggleModal(e)},updateTagContainerByCounts:function(){return _.each(this.tag_list_els,function(e,t){var i=models.tag_facets.get(t);e.find(".count").html(i.length);var a=i.length>0;e.toggleClass("disabled",!a)},this),this}}),app.Settings=Backbone.View.extend({el:"#main-wrapper",events:{"click button.add":"addItem"},initialize:function(){this._subviews=[],this.$drawer=$("#drawer"),this.$content=$("#content"),this.default_recipes={"rss-feeds":{view_name:"SettingRssFeed",recipe_name:app.defaults.rss_feed_recipe_name,options:{template:templates.rssFeedRecipeFactory}},"staff-twitter-lists":{view_name:"SettingStaffTwitterList",recipe_name:app.defaults.staff_twitter_list_to_promotion_recipe_name,options:{template:templates.staffTwitterListRecipeFactory}},"twitter-users":{view_name:"SettingTwitterUser",recipe_name:app.defaults.staff_twitter_user_to_promotion_recipe_name,options:{template:templates.twitterUserRecipeFactory}},"facebook-pages":{view_name:"SettingFacebookPage",recipe_name:app.defaults.staff_facebook_page_to_promotion_recipe_name,options:{template:templates.facebookPageRecipeFactory}},"subject-tags":{view_name:"SettingSubjectTag"},"impact-tags":{view_name:"SettingImpactTag"}},this.render()},render:function(){return collections.user_settings.instance.each(function(e){var t={email:{view:views.SettingSingle},password:{view:views.SettingPassword}},i=["email","password"];i.forEach(function(i){var a=new models.user_setting.Model(e.toJSON()),s=this.$content.find('.js-inputs-container[data-setting-name="'+i+'"]')[0],n=new t[i].view({model:a,el:s,valueKey:i});this._subviews.push(n)},this)},this),collections.settings.instance.each(function(e){var t=e.get("name"),i=this.$content.find('.js-inputs-container[data-setting-name="'+t+'"]')[0],a=new views.SettingSingle({model:e,el:i,valueKey:"value"});this._subviews.push(a)},this),_.each(this.default_recipes,function(e,t){var i=(e.recipe_name,collections.recipes.instance.where({name:e.recipe_name})),a=this.$content.find('.js-inputs-container[data-setting-name="'+t+'"]');i.length&&this.setGroupEmpty(a.parents(".js-setting-group"),"false"),i.forEach(function(t){var i=_.extend({model:t,parentEl:a[0]},e.options),s=new views[e.view_name](i);a.append(s.el),this._subviews.push(s)},this)},this),collections.subject_tags.instance.each(function(e){var t=this.$content.find('.js-inputs-container[data-setting-name="subject-tags"]'),i=new views.SettingSubjectTag({model:e});t.append(i.el),this._subviews.push(i)},this),collections.impact_tags.instance.each(function(e){var t=this.$content.find('.js-inputs-container[data-setting-name="impact-tags"]'),i=new views.SettingImpactTag({model:e});t.append(i.el),this._subviews.push(i)},this),this},setGroupEmpty:function(e,t){return e.attr("data-empty",t),this},addItem:function(e){var t=$(e.currentTarget),i=t.parents(".js-setting-group"),a=i.attr("data-empty");"true"===a&&this.setGroupEmpty(i,"false");var s=t.siblings(".js-inputs-container"),n=s.attr("data-setting-name"),r=this.default_recipes[n],o=r.options||{},l=new views[r.view_name](o);return s.append(l.el),this._subviews.push(l),this},reportError:function(e){return console.log("Error",e),!1}}),app.Submit=Backbone.View.extend({el:"#main-wrapper",events:{"submit form":"saveForm"},initialize:function(){this._subviews=[],this.$formContainer=this.$el.find("#form-container"),this.render()},render:function(){var e={status:"pending"},t=new views.EventCreator({el:this.$formContainer[0],model:e,collection:this.collection,disableModal:!0,saveMsg:"Pending event added to the Approval River!"});return this._subviews.push(t),this._time_picker=t._time_picker,this}}),app.helpers={drawer:{determineBehavior:function(){var e="radio";return"compare"==models.section_mode.get("mode")&&(e="checkbox"),e},getAllIds:function(){var e=[];return _.each(this.drawerData,function(t){e.push(t[this.listId])},this),e}},gifizeLoadMoreButton:function(e){e.html("Loading... ").addClass("disabled").addClass("loading-spinner")},isotope:{initCntnr:function(e){this.$isotopeCntnr=this.$listContainer,this.$isotopeCntnr.isotope({itemSelector:this.isotopeChild,masonry:{columnWidth:400},getSortData:e})},clearCntnr:function(){this.$isotopeCntnr&&(this.$isotopeCntnr=null)},addItem:function(e){this.$isotopeCntnr.isotope("appended",e)},relayout:function(e,t){e=e||"timestamp",_.isUndefined(t)&&(t=!1),app.instance.$isotopeCntnr.isotope({sortBy:e,sortAscending:t}),app.instance.$isotopeCntnr.isotope("layout")}},flattenDataStructures:{init:function(e){var t=this,i={};return _.each(e,function(e,a,s){var n;i.topLevelInfo&&(n=i.topLevelInfo[0]),i[a]=t[a](e,n)}),i},topLevelInfo:function(e){e.article_datetime=helpers.templates.fullIsoDate(e.article_timestamp),e.article_authors=e.article_authors.join("|"),e.article_subject_tags=e.article_subject_tags.map(function(e){return e.name}).join("|"),e.article_impact_tags=e.article_impact_tags.map(function(e){return e.name}).join("|"),e.article_impact_tag_categories=e.article_impact_tag_categories.map(function(e){return e.name}).join("|"),e.article_impact_tag_levels=e.article_impact_tag_levels.map(function(e){return e.name}).join("|"),e.article_links=e.article_links.join("|"),e.article_entities=e.article_entities.join("|"),e.article_keywords=e.article_keywords.join("|"),e.quant_metrics.forEach(function(t){var i=t.metric,a=t.value;e["article_total_"+i]=a}),delete e.quant_metrics,e.device_facets.forEach(function(t){var i=t.facet,a=t.pageviews,s=t.entrances;e["article_total_"+i+"_pageviews"]=a,e["article_total_"+i+"_entrances"]=s}),delete e.device_facets;var t=e.social_network_facets.filter(function(e){return!_.isEmpty(e)});return t.forEach(function(t){var i=t.facet,a=t.pageviews,s=t.entrances;e["article_total_"+i+"_pageviews"]=a,e["article_total_"+i+"_entrances"]=s}),delete e.social_network_facets,[e]},tweets:function(e,t){{var i=[];_.pick(t,"article_story_id")}return e.forEach(function(e){var a={};_.extend(a,e),a.datetime=helpers.templates.fullIsoDate(e.timestamp),a.hashtags=a.hashtags.join("|"),a.img_urls=a.img_urls.join("|"),a.story_ids=a.story_ids.join("|"),a.urls=e.urls.join("|"),a.user_mentions=e.user_mentions.join("|"),_.extend(a,t),i.push(a)}),i},timeseries:function(e,t){var i=[],a=_.pick(t,"article_story_id");return e.forEach(function(e){var t={};_.extend(t,e),t.datetime=helpers.templates.fullIsoDate(e.timestamp),_.extend(t,a),i.push(t)}),i},promotions:function(e,t){var i=[],a=_.pick(t,"article_story_id");return e.forEach(function(e){var t={};_.extend(t,e),e.story_ids&&(t.story_ids=e.story_ids.join("|")),Array.isArray(t.timestamp)&&(t.end_timestamp=t.timestamp[1],t.timestamp=t.timestamp[0]),Array.isArray(t.urls)&&(t.urls=t.urls.join("|")),t.datetime=helpers.templates.fullIsoDate(e.timestamp),_.extend(t,a),i.push(t)}),i},events:function(e,t){var i=[],a=_.pick(t,"article_story_id");return e.forEach(function(e){var t={};_.extend(t,e),t.impact_tag_categories=t.impact_tag_categories.map(function(e){return e.name}).join("|"),t.impact_tag_levels=t.impact_tag_levels.map(function(e){return e.name}).join("|"),t.impact_tags_full=t.impact_tags_full.map(function(e){return e.name}).join("|"),t.datetime=helpers.templates.fullIsoDate(e.timestamp),delete t.impact_tags,_.extend(t,a),i.push(t)}),i},comparisons:function(e,t){var i=[],a=_.pick(t,"article_story_id");return _.each(e,function(e,t){var s=t;"null"==s?s="NA":"all"!=s&&(s=_.findWhere(pageData.subject_tags,{id:+t}).name),e.forEach(function(e){var t={};_.extend(t,e),t.group=s,_.extend(t,a),i.push(t)})}),i}}},Backbone.View.prototype.killView=function(){this._time_picker&&this._time_picker.destroy(),this.killAllSubviews(),this.undelegateEvents(),this.remove()},Backbone.View.prototype.silenceView=function(){this.silenceAllSubviews(),this.undelegateEvents(),this._time_picker&&this._time_picker.destroy()},Backbone.View.prototype.silenceAllSubviews=function(){this._subviews&&_.isArray(this._subviews)&&(this._subviews.forEach(function(e){e.silenceView()}),this._subviews=[])},Backbone.View.prototype.killAllSubviews=function(){this._subviews&&_.isArray(this._subviews)&&(this._subviews.forEach(function(e){e.killView()}),this._subviews=[])},views.AA_BaseArticleViz=Backbone.View.extend({tagName:"section",className:"article-detail-viz-container",setMarkup:function(){this.setTitle(),this.setContainer()},setTitle:function(){return this.$el.html('<h3 class="title">'+this.section_title+"</h3>"),this},calcComparisonMarkerParams:function(){return this.comparison_marker_operation=collections.article_comparisons.instance.metadata("operation"),this.comparison_marker_group=collections.article_comparisons.instance.metadata("group"),this},setContainer:function(){return this.$vizContainer=$('<div class="viz-container"></div>').appendTo(this.$el),this},fancyPercent:function(e){return.01>e?"<1%":Math.round(100*e)+"%"},render:function(e){var t=this,i=this.$vizContainer.get(0),a=d3.select(i),s=a.selectAll(".bar-container").data(this.data).enter(),n=s.append("div").classed("bar-container",!0);n.append("div").classed("bar",!0).style("width",function(e){return(e.pageviews/t.total*100).toFixed(2)+"%"});var r;return e&&(r=n.append("div").classed("marker-container",!0).style("left",function(e){return t.calcLeftOffset(e.facet,t.comparison_marker_operation)}).classed("tooltipped",!0).attr("aria-label",function(e){var i=helpers.templates.toTitleCase(t.comparison_marker_operation);return"Mean"==i&&(i="Average"),i+" of "+t.comparison_marker_group+" articles: "+t.calcLeftOffset(e.facet,t.comparison_marker_operation)}).attr("data-tooltip-align",function(e){var i=parseInt(t.calcLeftOffset(e.facet,t.comparison_marker_operation)),a="center";return 20>=i?a="left":i>75&&(a="right"),a}).append("div").classed("marker",!0)),n.append("div").classed("label",!0).html(function(e){var i=t.fancyPercent(e.pageviews/t.total),a=e.pageviews?helpers.templates.addCommas(e.pageviews):"";return"<strong>"+helpers.templates.toTitleCase(e.facet)+"</strong> &mdash; "+i+", "+a}),this.bar_container=n,this},redrawMarker:function(){this.calcComparisonMarkerParams();{var e=this;this.bar_container.selectAll(".marker-container").transition().duration(450).ease("exp-out").styleTween("left",function(t){{var i=parseFloat(d3.select(this).style("left")),a=this.parentNode.offsetWidth,s=i/a*100,n=e.calcLeftOffset(t.facet,e.comparison_marker_operation);parseFloat(n)*a}return d3.interpolate(s,n)}).attr("aria-label",function(t){return helpers.templates.toTitleCase(e.comparison_marker_operation)+" of "+e.comparison_marker_group+" articles: "+e.calcLeftOffset(t.facet,e.comparison_marker_operation)})}},calcLeftOffset:function(e,t,i){i=i||this.comparison_marker_group;var a,s,n=pageData.articleComparisons[i],r=-999,o=_.findWhere(pageData.articleComparisons[i],{metric:"per_"+e});return n&&o?(a=1,s=d3.scale.linear().domain([0,a]).range([0,100]),"string"==typeof t&&(t=o[t]),r=Math.round(s(t))):console.error("ERROR: "+i+" is not a comparison value in `pageData.articleComparisons` or per_"+e+" does not exist as a metric in that group."),r.toString()+"%"}}),views.AA_BaseForm=Backbone.View.extend({events:{"click .modal-overlay":"toggleModal","click .modal-close":"toggleModal","click .article-assignee":"removeArticleAssignee"},killPropagation:function(e){e.stopPropagation()},toggleModal:function(e){e.stopPropagation(),views.helpers.toggleModal(e)},assignmentTemplateFactory:_.template('<div class="article-assignee""><span class="remove-assignee labelled" aria-label="<%= title %>" >&times;</span><input type="hidden" name="content_items[]:object" value=\'{"id": <%= id %>, "title": "<%= title %>"}\'/></div>'),bakeModal:function(e){var t="";t+='<div class="modal-overlay"></div>',t+='<div class="modal-inner">',t+='<div class="modal-title">'+e+"</div>",t+="<form></form>",t+="</div>";var i=this.$el.hasClass("modal-outer")?this.$el:this.$el.find(".modal-outer");return i.append(t),this.$form=i.find("form"),this},refresh:function(e){this.render(),this.postRender(e)},postRender:function(e){e.search&&this.initArticleTitleSearcher(),e.pikaday&&this.initPikaday(),this.$submitMsgText=this.$el.find(".submit-msg");var t=this.$el.find(".modal-outer")[0];return void 0!==window.d3&&d3.select(t).call(this.drag()),this},removeSetEventPrefix:_.identity,bakeFormInputRow:function(e,t,i,a){var s={time_of_day:"schedule_by",crontab:"schedule_by",minutes:"schedule_by"},n=t.input_type,r="hidden"==n,o=this.prettyName(e),l=this.removeSetEventPrefix(e),c="",d=t.help&&t.help.link,h=t.help&&t.help.description,u=["slug"],m=s[l]||"";return i=i||!1,_.contains(u,e)||(c='<div class="form-row" data-which="'+l+'" data-group="'+m+'" data-hidden="'+r+'">',c+='<div class="form-row-label-container '+(d?"has-help-link":"")+'">',c+='<label for="'+e+'"> '+o+(h?'<span class="tooltipped question-mark" aria-label="'+t.help.description+'">?</span>':"")+"</label> ",c+="</div>",c+='<div class="form-row-input-container" data-which="'+l+'">',d&&(c+='<div class="help-row"><a href="'+t.help.link+'" target="_blank">What do I put here?</a></div>'),this.formJsonToMarkup[n]||console.log("ERROR: Your specified `input_type` of ",n,"on the object",t,"is missing a corresponding function in `formJsonToMarkup`"),c+=this.formJsonToMarkup[n].call(this,e,t,i,a),c+="</div>",c+="</div>"),c},formJsonToMarkup:{search:function(e,t,i){e="assignees-selector";var a='<input type="text" name="'+e+'" class="'+e+'" placeholder="'+(t.help&&t.help.placeholder?this.escapeQuotes(t.help.placeholder):"")+'" data-is-default-event="'+i+'" data-serialize-skip="true"/>';return a},content_items:function(e){var t="";return e.forEach(function(e){t+=this.assignmentTemplateFactory(e)},this),t},set_event_content_items:function(e){return this.formJsonToMarkup.content_items.call(this,e)},datepicker:function(e,t,i){var a=this.removeSetEventPrefix(e),s=t.required?"required":"",n='<input type="text" data-type="datepicker" class="'+a+'" '+s+' placeholder="'+(t.help&&t.help.placeholder?this.escapeQuotes(t.help.placeholder):"")+'" autocomplete="off" data-is-default-event="'+i+'" data-serialize-skip="true"/>';return n+='<input type="hidden" name="'+e+'" data-type="datepicker-value" class="'+a+'" data-is-default-event="'+i+'"/>'},textNumberOrHidden:function(e,t,i,a,s){s=s||t.selected;var n=this.escapeQuotes(s),r=this.removeSetEventPrefix(e),o=t.required?"required":"",l='<input type="'+i+'" name="'+e+':auto" class="'+r+'" value="'+this.escapeQuotes(n)+'" '+o+' placeholder="'+(t.help&&t.help.placeholder?this.escapeQuotes(t.help.placeholder):"")+'" '+("number"==i?'min="0"':"")+' data-is-default-event="'+a+'"/>';return l},text:function(e,t,i,a){return this.formJsonToMarkup.textNumberOrHidden.call(this,e,t,"text",i,a)},hidden:function(e,t,i,a){return this.formJsonToMarkup.textNumberOrHidden.call(this,e,t,"hidden",i,a)},searchstring:function(e,t,i,a){return this.formJsonToMarkup.text.call(this,e,t,i,a)},number:function(e,t,i,a){return this.formJsonToMarkup.textNumberOrHidden.call(this,e,t,"number",i,a)},paragraph:function(e,t,i,a){a=a||t.selected;var s=this.escapeQuotes(a)||"",n=this.removeSetEventPrefix(e),r='<textarea type="text" name="'+e+'" class="'+n+'" placeholder="'+(t.help&&t.help.placeholder?this.escapeQuotes(t.help.placeholder):"")+'" data-is-default-event="'+i+'">'+s+"</textarea>";return r},select:function(e,t,i,a){a=a||t.selected;var s=this.removeSetEventPrefix(e),n=t.required?"required":"",r='<select class="'+s+'" name="'+e+':auto" data-is-default-event="'+i+'" '+n+">";return _.each(t.input_options,function(e){var t="";a==e&&(t="selected"),r+='<option value="'+e+'" '+t+">"+this.prettyName(e)+"</option>"},this),r+="</select>"},checkbox:function(e,t,i,a){a=a||t.selected;var s="",n="NewsLynx";return t.input_options.length||(s='<span class="placeholder">You haven\'t yet made any '+e.replace(/^set_event_/,"").replace(/_/g," ")+' yet. Create them on the <a href="/settings" target="_blank" class="out-link">Settings</a> page.</span>'),_.each(t.input_options,function(t){var r=this.styleCheckboxLabel(t),o=_.uniqueId(n+"|"+e+"|"+t.id+"|");s+='<div class="form-checkbox-group tags">';var l="",c=a;_.contains(c,t.id)&&(l="checked"),s+='<input class="tag" id="'+o+'" name="'+e+'[]:number" value="'+t.id+'" type="checkbox" '+l+' data-is-default-event="'+i+'"/>',s+='<label class="tag" for="'+o+'" '+r+">"+t.name+"</label>",s+="</div>"},this),s}},styleCheckboxLabel:function(e){var t=e.color,i=this.whiteOrBlack(t);return'style="background-color:'+t+";color:"+i+';"'},prettyName:function(e){/^set_event_/.test(e)&&(e=e.replace("set_event_",""));var t={q:"search_query",content_items:"Assign to..",url:"URL",img_url:"Image URL",filter:"search_query",min_followers:"min. followers",tag_ids:"impact tag(s)",datetime:"date / time",interval:"interval (seconds)",title:"event title"};return t[e]&&(e=t[e]),e||(e=""),e=e.replace(/_/g," "),e.charAt(0).toUpperCase()+e.slice(1)},escapeQuotes:function(e){return 0===e?e:e?"string"!=typeof e?e:e.replace(/"/g,"&quot;"):""},prettyDatestamp:function(e){return new Date(e).toLocaleString()},initArticleTitleSearcher:function(){var e=this.$el.find(".assignees-selector"),t=_.findWhere(this.full_schema,{input_type:"search"}),i=this;return!t&&this.full_info.vals&&(t={selected:this.full_info.vals.content_items}),this.$typeaheadRow=e.parents(".form-row"),$('<div class="form-row article-assignees" ></div>').insertAfter(this.$typeaheadRow),e.typeahead({highlight:!0,minLength:3},{name:"content-items",displayKey:"title",async:!0,source:function(e,t,i){var a="/api/_VERSION/content?q="+e+"&search=title&fields=id,title";$.ajax({url:a,dataType:"json",success:function(e){i(e.content_items)}})}}),e.on("typeahead:selected",function(e,a){e.preventDefault(),$(this).typeahead("val",""),i.addArticleAssignee(a,t.selected)}),_.isArray(t.selected)&&t.selected.forEach(function(e){i.addArticleAssignee(e,[])}),this},addArticleAssignee:function(e,t){var i,a,s;if(e){i=this.$el.find(".form-row.article-assignees"),a=e.id;{this.getSettings(!0)}_.contains(_.pluck(t,"id"),a)||(s=this.assignmentTemplateFactory(e),i.append(s))}else console.log("ERROR: Article assignee not found");return this},removeArticleAssignee:function(e){return $(e.currentTarget).remove(),this},initPikaday:function(){var e,t=this.$el.find('input[data-type="datepicker"]'),i=t[0],a=t.siblings('input[data-type="datepicker-value"]');e=new Pikaday({field:i,showTime:!0,use24hour:!0,timezone:pageData.timezone,onSelect:function(){var e=this.getMoment(),i=e.format(),s=e.format(helpers.templates.prettyDateTimeFormat);a.val(i),t.val(s)}});var s,n,r;return this.full_info?r=this.full_info.vals.created:(s=this.full_schema,n=_.findWhere(s,{input_type:"datepicker"})||{},r=n.selected),r&&(r=moment(r),e.setMoment(r)),this._time_picker=e,this},whiteOrBlack:function(e){var t=this.hexToRgb(e),i=t.r,a=t.g,s=t.b,n=(299*i+587*a+114*s)/1e3;return n>=128?"black":"white"},hexToRgb:function(e){var t=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;e=e.replace(t,function(e,t,i,a){return t+t+i+i+a+a});var i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return i?{r:parseInt(i[1],16),g:parseInt(i[2],16),b:parseInt(i[3],16)}:null},bakeButtons:function(e){var t='<div class="buttons-container">';return t+='<button class="cancel modal-close">Cancel</button>',t+='<input class="save" type="submit" value="Save"/>',t+='<span class="submit-msg"></span>',e&&(t+='<input class="destroy" type="button" value="Delete"/>'),t+="</div>"},combineFormSchemaWithVals:function(e,t){var i={};return _.each(t,function(a,s){e[s]||(console.log("Your key name",s,"in your settings object of ",t),console.log("Needs a corresponding schema structure in",e));var n=e[s].selected||[];i[s]=e[s];var r=["tag_ids","set_event_tag_ids","content_items","set_event_content_items"];i[s].selected=_.contains(r,s)?n.concat(a):a}),i},validate:function(e,t,i,a){var s,n=_.keys(t),r=(_.values(t),[]),o="";r.push(_.difference(e,n)),_.each(t,function(e,t){(void 0===e||e===!1||""===e)&&(r=r.concat(t))}),r=_.flatten(r),r=_.intersection(e,r),r.length>0?(r.length>1&&(o="s"),r=r.map(function(e){return'"'+helpers.templates.toTitleCase(e).replace(/_/g," ")+'"'}).join(", "),s="You didn't include information for the required field"+o+": "+r+".",i.call(a,"Missing fields",s)):i.call(a,null,"Saving!")},validateNew:function(e,t,i,a){var s=[];_.each(e,function(e,t){e.required&&s.push(t)});var n,r=_.keys(t),o=(_.values(t),[]),l="";o.push(_.difference(s,r)),_.each(t,function(e,t){(void 0===e||e===!1||""===e)&&(o=o.concat(t))}),o=_.flatten(o),o=_.intersection(s,o),o.length>0?(o.length>1&&(l="s"),o=o.map(function(e){return'"'+helpers.templates.toTitleCase(e).replace(/_/g," ")+'"'}).join(", "),n="You didn't include information for the required field"+l+": "+o+".",i.call(a,"Missing fields",n)):i.call(a,null,"Saving!")},printMsgOnSubmit:function(e,t){var i="success";e&&(i="fail"),this.$submitMsgText.removeClass("success").removeClass("fail"),this.$submitMsgText.addClass(i).html(t)},getSettings:function(e){var t=this.$el.find('form :input[data-serialize-skip!="true"]').filter(function(){var e=$(this);return e.val()||0===e.val()||/^set_event_/.test(e.attr("name"))});e||(t=t.filter(function(){return!$(this).attr("data-is-default-event")||"false"==$(this).attr("data-is-default-event")}));var i=t.serializeJSON();return i},drag:function(){return d3.behavior.drag().on("drag",function(e,t,i){if(this.canDrag){var a=d3.select(this).select(".modal-inner"),s=parseInt(a.style("top")),n=parseInt(a.style("left"));s+=d3.event.dy,n+=d3.event.dx,a.style("top",s+"px").style("left",n+"px")}}).on("dragstart",function(){var e=[".form-row-input-container"],t=$(d3.event.sourceEvent.explicitOriginalTarget),i=_.every(e,function(e){return t.hasClass(e.replace(".",""))?!1:t.parents(e).length>0?!1:!0});this.canDrag=i})}}),views.AA_BaseRecipe=views.AA_BaseForm.extend({events:_.extend({"change .schedule_by":"getScheduleByVal"},views.AA_BaseForm.prototype.events),assignmentTemplateFactory:_.template('<div class="article-assignee"><span class="remove-assignee labelled" aria-label="<%= title %>" >&times;</span><input type="hidden" name="set_event_content_items[]:object" value=\'{"id": <%= id %>, "title": "<%= title %>"}\' data-is-default-event="true"/></div>'),removeSetEventPrefix:function(e){return e.replace(/^set_event_/,"")},getScheduleByVal:function(e){var t=$(e.currentTarget),i=t.val();return this.updateScheduleByLayout(i),this},updateScheduleByLayout:function(e){return e?(this.$form.find('.form-row[data-group="schedule_by"][data-which!="'+e+'"]').hide(),this.$form.find('.form-row[data-group="schedule_by"][data-which="'+e+'"]').show()):this.$form.find(".schedule_by").trigger("change"),this},separateSchemaFromEvent:function(e){var t=$.extend(!0,{},e),i=_.pick(t,function(e,t){return!/^set_event_/.test(t)}),a=_.pick(t,function(e,t){return/^set_event_/.test(t)});return{settingsInfo:i,eventInfo:a}}}),views.AA_BaseSetting=Backbone.View.extend({events:{"change .js-input-item.color-picker":"inputHasChanged","keyup .js-input-item":"inputHasChanged","keypress .js-input-item":"inputHasChangedFromKeypress","change .js-input-item":"inputHasChanged","click .js-input-item":"inputHasChanged","change select.js-input-item":"inputHasChanged",'click .input-action-btn[data-which="cancel"]':"revertToPreviousSettingVal","submit .js-parent-form":"saveModel","click .modal-overlay":"toggleModal","click .modal-close":"toggleModal","click .multi-child.js-destroy":"toggleModal","click input.js-destroy":"destroyModel"},keepPreviousValueIfExists:!1,initializeBase:function(){return this.$form=this.$el.find("form"),this.listenTo(this.model,"change:input_val",this.compareFormData),this.listenTo(this.model,"change:data_changed",this.setDataChanged),this.listenTo(this.model,"destroy",this.remove),this.listenTo(this.model,"error",this.error),this.listenTo(this.model,"invalid",this.error),this},remove:function(){return this.$el.animate({opacity:0},400,"easeOutQuart").animate({height:0},175,"easeOutQuart").queue(function(e){$(this).remove(),e()}),this},error:function(e,t){return console.log("####### MODEL SAVE ERRROR #######"),console.log(e.toJSON()),console.log(JSON.stringify(t)),console.log("####### end model save error #######"),alert("There was an error saving. Please open your console and paste the output to merlynne@newslynx.org. Or follow its instructions if present."),this},postRender:function(){return this.bakeInputActions(),this.compareFormData(),this},inputHasChanged:function(e){e.stopPropagation();{var t,i=27;e.metaKey}return e.keyCode==i?this.revertToPreviousSettingVal(e):(t=this.getCurrentFormData(),this.model.set("input_val",t)),this},inputHasChangedFromKeypress:function(e){var t=13,i=e.metaKey;e.keyCode==t&&i?this.saveModel(e):e.keyCode!=t||i||(e.preventDefault(),e.stopPropagation())},compareFormData:function(){var e=this.getRelevantSavedFormData(),t=this.model.get("input_val")||this.getCurrentFormData(),i=!_.isEqual(e,t);return console.log("saved",e),console.log("current",t),this.model.set("data_changed",i),this},setDataChanged:function(e,t){return this.$form.attr("data-changed",t.toString()),this},getCurrentFormData:function(){var e=this.$form.serializeJSON(),t=this.standardizeEmptyFields(e);return t},getRelevantSavedFormData:function(){var e=$.serializeJSON,t=$.extend(!0,{},this.model.toJSON()),i=e.setupOpts({}),a=[],s={};this.$form.find("input,select").each(function(){var t,s=$(this).attr("name");s&&(t=e.splitInputNameIntoKeysArray(s,i),a.push(t))});var n=a.map(function(e){var i=(e.pop(),this.deepGet(t,e));return{keys:e,value:i}},this);return n.forEach(function(t){e.deepSet(s,t.keys,t.value,i)},this),s},standardizeEmptyFields:function(e){var t=_.clone(e);return _.each(t,function(e,i){e?_.isObject(e)&&(t[i]=this.standardizeEmptyFields(e)):t[i]=void 0},this),t},bakeInputActions:function(){var e=this.$form,t=templates.inputActionsFactory({}),i=$(templates.modalFactory({}));i.appendTo(e),e.append(t);var a=d3.behavior.drag().on("drag",function(e,t,i){if(this.canDrag){var a=d3.select(this).select(".modal-inner"),s=parseInt(a.style("top")),n=parseInt(a.style("left"));s+=d3.event.dy,n+=d3.event.dx,a.style("top",s+"px").style("left",n+"px")}}).on("dragstart",function(){var e=[".form-row-input-container"],t=$(d3.event.sourceEvent.explicitOriginalTarget),i=_.every(e,function(e){return t.hasClass(e.replace(".",""))?!1:t.parents(e).length>0?!1:!0});this.canDrag=i});return d3.select(i[0]).call(a),this},initColorPicker:function(e){var t=this;return this.$el.find(".color-picker").each(function(){var i=$(this);i.spectrum({preferredFormat:"hex",showPaletteOnly:!0,hideAfterPaletteSelect:!0,palette:t.palettes[e],change:function(e){i.val(e.toHexString())}})}),this},getVal:function(e){var t=$.serializeJSON,i=t.setupOpts({}),a=(e||this.valueKey||this.options.valueKey,t.splitInputNameIntoKeysArray(e,i)),s=this.model.toJSON(),n=(a.pop(),this.deepGet(s,a));return n},deepGet:function(e,t,i){e=$.extend(!0,{},e);var a;return(_.isEmpty(e)||!e[t[0]])&&t.length>1?(a={},a[t[0]]={}):a=e[t[0]],_.chain(t).rest().each(function(e){a=a[e]},this).value(),a},setVals:function(e){e=e||[this.options.valueKey];var t=this.assembleInputsData(e);return t.forEach(function(e){var t=e.$input,i=e.val,a=t.val()||"";(!this.keepPreviousValueIfExists||this.keepPreviousValueIfExists&&!a.trim())&&t.val(i)},this),this},revertToPreviousSettingVal:function(e){e.preventDefault();var t=this.$form,i=(this.getRelevantSavedFormData(),this);this.model.set("data_changed","false");var a={normal:function(e,t){return e.val(t),this},color:function(e,t){return e.spectrum("set",t),this}};return t.find('input[type="text"],select').each(function(){var e=$(this),t=e.attr("name"),s=i.getVal(t),n="normal";"color"==t&&(n="color"),a[n](e,s)}),this},palettes:{"subject-tag":[["#1f78b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"],["#aec7e8","#ffbb78","#98df8a","#ff9896","#c5b0d5","#c49c94","#f7b6d2","#c7c7c7","#dbdb8d","#9edae5"]],"impact-tag":[["#6699cc","#66cccc","#99cc99","#cc99cc","#d27b53","#f2777a","#f99157","#ffcc66","#bc80bd","#ccebc5","#ffed6f"]]},assembleInputsData:function(e){var t=e.map(function(e){return{$input:this.$form.find('.js-input-item[name="'+e+'"]'),val:this.getVal(e)}},this);return t},saveModel:function(e){e.preventDefault(),this.preSaveHook&&this.preSaveHook();var t,i=this,a=this.getCurrentFormData();return a.options&&(t=_.pick(this.model.get("options"),function(e){var t;return t=0===e?!0:e}),a.options=_.extend(t,a.options)),this.model.save(a,{patch:!0,success:function(){i.modelSaved(!0)},error:function(){i.modelSaved(!1)}}),this},modelSaved:function(e){return this.model.set("data_changed",!e),e&&(this.$form.attr("data-new","false"),this.$el.removeClass("js-destroy-wait"),this.postSaveHook&&this.postSaveHook(),this.$form.addClass("js-just-saved").delay(1500).queue(function(e){$(this).removeClass("js-just-saved"),e()})),this},destroyModel:function(e){this.toggleModal(e),this.$el.addClass("js-destroy-wait"),this.model.destroy({wait:!0})},toggleModal:function(e){e.stopPropagation(),views.helpers.toggleModal(e)}}),views.AA_BaseSettingListItemRecipe=views.AA_BaseSetting.extend({tagName:"li",render:function(){var e=this.options.template||this.template,t=this.options.parentEl||this.parentEl;return e&&(this.$el.html(e({})),t&&$(t).append(this.el)),this},checkIfNew:function(){return this.model||(this.model=new models.recipe.Model(this.default_model_opts),collections.recipes.instance.add(this.model),this.$el.find(".js-parent-form").attr("data-new","true")),this},preSaveHook:function(){var e=this.model.get("options");e.search_query||(e.search_query=pageData.org.homepage,this.model.set("options",e))}}),views.AA_BaseTag=Backbone.View.extend({whiteOrBlack:function(e){var t=this.hexToRgb(e),i=t.r,a=t.g,s=t.b,n=(299*i+587*a+114*s)/1e3;return n>=128?"black":"white"},hexToRgb:function(e){var t=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;e=e.replace(t,function(e,t,i,a){return t+t+i+i+a+a});var i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return i?{r:parseInt(i[1],16),g:parseInt(i[2],16),b:parseInt(i[3],16)}:null},colorLuminance:function(e,t){e=String(e).replace(/[^0-9a-f]/gi,""),e.length<6&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]),t=t||0;var i,a,s="#";for(a=0;3>a;a++)i=parseInt(e.substr(2*a,2),16),i=Math.round(Math.min(Math.max(0,i+i*t),255)).toString(16),s+=("00"+i).substr(i.length);return s},styleLayout:function(){var e=this.model.get("color"),t=this.whiteOrBlack(e),i=this.colorLuminance(e,-.25);return this.$el.css({"background-color":e,color:t,border:"1px solid"+i}),this},styleLayoutWithTooltip:function(){this.styleLayout();var e=this.getTooltipText();return this.$el.addClass("tooltipped").attr("aria-label",e),this},getTooltipText:function(){var e=this.model.get("category"),t=helpers.templates.prettyName(this.model.get("level")),i=t+" "+e;return i}}),views.AddArticle=views.AA_BaseForm.extend({events:_.extend({"submit form":"addArticle"},views.AA_BaseForm.prototype.events),initialize:function(e){var t=$.extend(!0,{},pageData.addArticleSchema);this.event_schema=t,this.bakeModal("Add an article"),this.render(),this.postRender({pikaday:!0})},render:function(){var e="",t=$.extend(!0,{},this.event_schema);return _.each(t,function(t,i){e+=this.bakeFormInputRow.call(this,i,t)},this),e+=this.bakeButtons(),this.$form.html(e),this.event_data={subject_tags:[]},this},formListToObject:function(){var e=this.event_creator_options,t={impact_tags:[],assignees:[]};return e.forEach(function(e){var i=e.name,a=e.selected;"subject_tags"!=i?t[i]=a:t[i].push(a)}),t},addArticle:function(e){e.preventDefault();var t=this.event_data,i=new models.new_article.Model;

delete t.undefined;var a=["created","url","title","authors"];this.validate(a,function(a,s){t.authors&&(t.authors=t.authors.split(",").map(function(e){return e.trim()}));var n=this;a?this.printMsgOnSubmit(a,s):(n.refresh({pikaday:!0}),i.save(t,{error:function(e,t,i){console.log("Error in article creation",t),n.printMsgOnSubmit(!0,'Could not save to the server. Send me an email with a description of what you were doing and I\'ll look into it: <a href="mailto:meow@newslynx.org">meow@newslynx.org</a> &mdash; <em>Merlynne</em>.')},success:function(t,i,a){console.log("Saved event",i),views.helpers.toggleModal(e),n.refresh({pikaday:!0})}}))})}}),views.Alert=Backbone.View.extend({tagName:"div",className:"article-detail-wrapper modal-parent",events:{'click .approval-btn-container[data-which="no"]':"makeInsignificant",'click .approval-btn-container[data-which="yes"]':"toggleModal","submit form":"createEvent"},initialize:function(){return this.listenTo(this.model,"change:destroy",this.destroy),this._subviews=[],this._time_picker,this},render:function(){var e=this.model.toJSON(),t=templates.alertFactory(_.extend(e,helpers.templates));return this.$el.html(t),this.$form=this.$el.find("form"),this.postRender(),this},postRender:function(){return this.bakeEventCreator(),this},bakeEventCreator:function(){var e=new views.EventCreatorFromAlert({el:this.el,model:this.model.toJSON()});return this._subviews.push(e),this._time_picker=e._time_picker,this.$el.append(e.el),this.event_creator_view=e,this},toggleModal:function(e){var t=$(e.currentTarget).parents(".modal-parent").find(".modal-outer"),i="none"==t.css("display");views.helpers.toggleModal(e),i&&t.find('input[name="assignees-selector"]').focus()},createEvent:function(e){e.preventDefault();var t=this,i=this.event_creator_view,a=i.getSettings(),s=i.required_keys;return this.event_creator_view.validate(s,a,function(s,n){s?i.printMsgOnSubmit(s,n):t.model.save(a,{error:function(e,t,a){console.log("Server error on recipe edit",t),i.printMsgOnSubmit(!0,"Error "+s.status+": "+s.message.replace(/\n/g,"<br/><br/>"))},success:function(i,a,s){console.log("Saved event",a),views.helpers.toggleModal(e),t.removeItem("save")}})},this),this},makeInsignificant:function(e){var t=this;this.model.set("making_insignificant",!0),this.model.destroy({success:function(e,i){t.removeItem("delete")},error:function(e){console.log("Error deleting event.",e)}})},removeItem:function(e){this.model.set("destroy",e)},destroy:function(e,t){var i=e.get("making_insignificant");"remove"!=t||i?"delete"==t?this.removeAlertColorfully("delete"):"save"==t&&this.removeAlertColorfully("save"):this.killView()},removeAlertColorfully:function(e){function t(){this.event_creator_view._time_picker.destroy(),this.killView()}var i,a,s=this,n=500;"save"==e?i="#D0F1D1":"delete"==e&&(i="#FFD0D0");var a=this.$el.css("height")+10,r={width:0,opacity:0,"margin-top":0,"margin-right":0,height:0,"margin-bottom":a};$(window).width()>1260?(r["padding-left"]=0,r["padding-right"]=0):(r["padding-bottom"]=0,r["margin-bottom"]=0),this.$el.css({"background-color":i,overflow:"hidden","white-space":"nowrap"}).animate(r,n).delay(0).queue(function(e){t.call(s)})}}),views.ArticleComparisonGrid=Backbone.View.extend({tagName:"div",className:"compare-grid-container",events:{"click .header-el":"sortColumn"},initialize:function(){this.sortAscending=collections.article_comparisons.instance.metadata("sort_ascending"),this.listenTo(collections.article_comparisons.instance,"resetMetricHeaders",this.setMetricHeaders),this.calcComparisonMarkerParams();var e=this.collection.cloneMetrics();return this.metric_comparisons=this.addComparisonInfo(e),this},render:function(){var e=_.extend({selects:this.collection.metadata("selects")},helpers.templates.articles),t=templates.articleGridContainerFactory(e);return this.$el.html(t),this.setMetricHeaders(),this},calcComparisonMarkerParams:function(){return this.comparison_marker_operation=collections.article_comparisons.instance.metadata("operation"),this.comparison_marker_group=collections.article_comparisons.instance.metadata("group"),this.comparison_marker_max=collections.article_comparisons.instance.metadata("max"),this},addComparisonInfo:function(e){var t=this.comparison_marker_group,i=models.comparison_metrics.get(t);return e.forEach(function(e){var t=_.findWhere(i,{metric:e.name})||{};_.extend(e,t)}),e},sortColumn:function(e){var t=$(e.currentTarget);t.hasClass("active")&&(this.sortAscending=!this.sortAscending);var i=t.attr("data-metric");return console.log("sort column running"),this.sortBy(i),this},sortBy:function(e){$(".header-el").removeClass("active"),$('.header-el[data-metric="'+e+'"]').addClass("active"),app.instance.$isotopeCntnr.isotope({sortBy:e,sortAscending:this.sortAscending}),collections.article_comparisons.instance.metadata("sort_ascending",this.sortAscending),collections.article_comparisons.instance.metadata("sort_by",e),collections.article_comparisons.instance.setComparator(e),console.log("grid sort by running"),collections.article_comparisons.instance.sort(),app.instance.saveHash(),$(".header-el").attr("data-sort-ascending",this.sortAscending)},setMetricHeaders:function(){this.calcComparisonMarkerParams();var e=this.comparison_marker_operation,t=this.comparison_marker_group,i=e,a=i;this.metric_comparisons.forEach(function(s){var n=s.name,r=this.$el.find('.header-el[data-metric="'+n+'"] .comparison-figure'),o=s[e];"number"==typeof o?o=helpers.templates.addCommas(o):console.log("WARNING: Could not find comparison value for: ",n,"For operation:",e,"In group:",t),"mean"==e&&(i="average",a="avg"),i=helpers.templates.toTitleCase(i),a=helpers.templates.toTitleCase(a);var l='<span class="comparison-figure-operation">'+a+': </span><span class="comparison-figure-value">'+o+"</span>";r.html(l).attr("aria-label",i+" of "+t+" articles.")},this)}}),views.ArticleDetail=Backbone.View.extend({tagName:"div",className:"article-detail-wrapper",events:{"click .tab":"setActiveTabFromClick","click .modal-toggle":"toggleModal",'click .modal-parent[data-which="subject"] .modal-close':"toggleModal","click .load-more":"moreEvents"},initialize:function(){this._subviews=[],this.listenTo(this.model,"destroyDetail",this.destroyView),this.article_detailed_events_collection=new collections.article_detailed_events.Collection,this.event_filters=new models.filters.Model({sort_by:"created"}),this.listenTo(this.article_detailed_events_collection,"add",this.eventsGallery.add),this.listenTo(this.article_detailed_events_collection,"remove",this.eventsGallery.remove),this.listenTo(this.article_detailed_events_collection,"error",this.reportErr),this.listenTo(collections.article_detailed_subject_tags.instance,"add",this.subject_tags.add),this.listenTo(collections.article_detailed_subject_tags.instance,"remove",this.subject_tags.remove),this.listenTo(collections.article_detailed_subject_tags.instance,"error",this.reportErr),this.listenTo(collections.article_detailed_impact_tags.instance,"add",this.impact_tags.add),this.listenTo(collections.article_detailed_impact_tags.instance,"remove",this.impact_tags.remove),this.listenTo(collections.article_detailed_impact_tag_attributes.categories_instance,"add",this.impact_tag_attribute.add),this.listenTo(collections.article_detailed_impact_tag_attributes.categories_instance,"remove",this.impact_tag_attribute.remove),this.listenTo(collections.article_detailed_impact_tag_attributes.levels_instance,"add",this.impact_tag_attribute.add),this.listenTo(collections.article_detailed_impact_tag_attributes.levels_instance,"remove",this.impact_tag_attribute.remove),this.listenTo(this.event_filters,"hasChanged",this.fetchEventsByParameters),models.event_tag_facets=new models.generic.Model({}),this.listenTo(models.event_tag_facets,"change",this.updateTagContainerByCounts),this.articles_impact_tags_collection=new collections.impact_tags.Collection(this.model.get("impact_tags_full")),this.articles_impact_tag_categories_collection=new collections.impact_tag_attributes.Collection(this.model.get("impact_tag_categories")),this.articles_impact_tag_levels_collection=new collections.impact_tag_attributes.Collection(this.model.get("impact_tag_levels")),this.articles_impact_tags_collection.metadata("filter","impact_tag_ids"),this.articles_impact_tag_categories_collection.metadata("filter","categories"),this.articles_impact_tag_levels_collection.metadata("filter","levels"),this.chartSelector="#ST-chart";var e=this;this.onWindowResize_throttled=_.throttle(this.onWindowResize,200),$(window).resize(function(){e.onWindowResize_throttled.call(e)})},render:function(){var e=this.model.toJSON(),t=templates.articleDetailFactory(_.extend(e,helpers.templates));return this.$el.html(t),this},reportErr:function(e,t){var i;i=ms.responseJSON?t.responseJSON:t,console.log("ERROR in model:",e),console.log("ERROR message:",i),alert(i.error+" "+i.status_code+": "+i.message)},setLoading:function(e,t){return e.attr("data-loading",t),this},bakeInteractiveBits:function(){return this.$eventCreator=$("#event-creator-container"),this.$subjectTagsContainer=this.$el.find('.article-info-container[data-which="subject"] > ul.tags'),this.$impactTagsContainer=this.$el.find('.article-info-container[data-which="impact"] ul.tags'),this.$impactTagCategoriesContainer=this.$el.find('.article-info-container[data-which="impact-categories"] ul.tags'),this.$impactTagLevelsContainer=this.$el.find('.article-info-container[data-which="impact-levels"] ul.tags'),this.$editSubjectTagsContainer=this.$el.find("#subject-tag-settings"),this.$impactTagsList=this.$el.find('.option-container[data-type="impact-tags"] .tag-list'),this.$impactTagCategoriesList=this.$el.find('.option-container[data-type="categories"] .tag-list'),this.$impactTagLevelsList=this.$el.find('.option-container[data-type="levels"] .tag-list'),this.tag_list_els={tags:this.$impactTagsList.parent(),categories:this.$impactTagCategoriesList.parent(),levels:this.$impactTagLevelsList.parent()},this.$eventsContainer=this.$el.find("#events-container"),this.$eventsGalleryContainer=this.$el.find("#events-gallery-container"),this.$downloadData=this.$el.find("#download-data"),this.bakeTags(),this.fetchEventsByParameters(!1,!0),this.bakeEventCreator(),this.setDetailNavigation(),this.setActiveTab(),this},bakeEventGalleryFurniture:function(){this.$eventsContainer.find(".placeholder").remove(),this.bakeEventsGalleryFilters()},setDownloadButton:function(){var e=this.model.toJSON(),t=this,i={topLevelInfo:{article_story_id:e.story_id,article_title:e.title,article_url:e.url,article_domain:e.domain,article_id:e.id,article_authors:e.authors,article_timestamp:e.timestamp,article_summary:e.summary,article_entities:e.entities,article_links:e.links,article_keywords:e.keywords,article_subject_tags:e.subject_tags_full,article_impact_tags:e.impact_tags_full,article_impact_tag_categories:e.impact_tag_categories,article_impact_tag_levels:e.impact_tag_levels,quant_metrics:e.quant_metrics,device_facets:e.referrer_metrics.device_facets,social_network_facets:e.referrer_metrics.social_network_facets},tweets:e.tweet_info,timeseries:e.timeseries_stats,promotions:e.promotions,events:e.events,comparisons:pageData.articleComparisons},a={topLevelInfo:"article_info"},s=app.helpers.flattenDataStructures.init(i);try{zip.zipMultiple(s,"csv",function(e,i){t.$downloadData.attr("href",i)},a)}catch(n){t.$downloadData.hide(),alert("Sorry. This article's data couldn't be prepped for download.\nPlease email me with the article URL and I'll get Michael and Brian to fix it: merlynne@newslynx.org.\n\nEverything else should be working fine."),console.log(e),console.log(s)}},bakeChart:function(){d3.select(this.chartSelector).datum(this.timeseriesData).call(this.spottedTail)},calcStickyOffsets:function(){var e,t=this.$el.find(".sticky"),i=this.$el.find(".sticky-anchor");return t.length&&i.length&&(e=i.position().top+$("#content").scrollTop(),t.attr("data-offset",e)),this},onWindowResize:function(){this.calcStickyOffsets()},bakeEventsGalleryFilters:function(){return this.articles_impact_tags_collection.length&&(this.$impactTagsList.html(""),this.articles_impact_tags_collection.each(function(e){var t=new views.TagEventFilter({model:e,filterModel:this.event_filters});this._subviews.push(t),this.$impactTagsList.append(t.render().el)},this)),this.articles_impact_tag_categories_collection.length&&this.articles_impact_tag_categories_collection.each(function(e){this.$impactTagCategoriesList.html("");var t=new views.TagEventFilter({model:e,filterModel:this.event_filters});this._subviews.push(t),this.$impactTagCategoriesList.append(t.render().el)},this),this.articles_impact_tag_levels_collection.length&&this.articles_impact_tag_levels_collection.each(function(e){this.$impactTagLevelsList.html("");var t=new views.TagEventFilter({model:e,filterModel:this.event_filters});this._subviews.push(t),this.$impactTagLevelsList.append(t.render().el)},this),this},bakeArticleVizs:function(){var e=this.$el.find('section.detail-section[data-group="reading"]'),t=this.$el.find('section.detail-section[data-group="tweeting"]'),i=this.model.get("referrer_metrics"),a=this.model.get("tweet_info");if(!_.isEmpty(i)){e.html("");var s=new views.ArticleDetailVizDeviceFacet({title:"On which devices are people reading?",referrer_metrics:i,which:"device"});this._subviews.push(s);var n=s.render("marker-also").el;e.append(n);var r=new views.ArticleDetailVizInternalExternal({title:"Is traffic internally or externally driven?",referrer_metrics:i,which:"internal-external"});this._subviews.push(r);var o=r.render("marker-also").el;e.append(o);var l=new views.ArticleDetailVizDomainFacets({title:"Who's sending readers here?",referrer_metrics:i,which:"domain-referrers"});this._subviews.push(l);var c=l.render().el;e.append(c);var l=new views.ArticleDetailVizArticleReferrers({title:"What articles link here?",referrer_metrics:i,which:"article-referrers"});this._subviews.push(l);var c=l.render().el;e.append(c)}if(!_.isEmpty(a)){t.html("");var d=new views.ArticleDetailVizTweets({title:"Who's tweeted this story?",tweet_info:a,which:"tweets"});this._subviews.push(d);var h=d.render().el;t.append(h)}return this},eventsGallery:{add:function(e){var t,i;return e.set("in_selection",!0),t=new views.ArticleDetailEvent({model:e}),this._subviews.push(t),i=t.render().el,this.$eventsGalleryContainer.append(i),this},remove:function(e){return e.set("in_selection",!1),this},setActiveEvents:function(){var e=views.po.article_detailed_events.getCurrentItems();this.article_detailed_events_collection.set([]),this.article_detailed_events_collection.set(e)}},updateEventGalleryItems:function(){return this},bakeTags:function(){var e=this.model.get("subject_tags_full"),t=this.model.get("subject_tag_input_options"),i=this.model.get("impact_tags_full"),a=this.model.get("impact_tag_categories"),s=this.model.get("impact_tag_levels");if(e.length?(this.$subjectTagsContainer.html(""),collections.article_detailed_subject_tags.instance.set(e)):collections.article_detailed_subject_tags.instance.set([]),i.length?(this.$impactTagsContainer.html(""),collections.article_detailed_impact_tags.instance.set(i)):collections.article_detailed_impact_tags.instance.set([]),a.length?(this.$impactTagCategoriesContainer.html(""),collections.article_detailed_impact_tag_attributes.categories_instance.set(a)):collections.article_detailed_impact_tag_attributes.categories_instance.set([]),s.length?(this.$impactTagLevelsContainer.html(""),collections.article_detailed_impact_tag_attributes.levels_instance.set(s)):collections.article_detailed_impact_tag_attributes.levels_instance.set([]),collections.subject_tags.instance.length){this.$editSubjectTagsContainer.html('<div class="description">Add subject tags to this article.</div>'),t.forEach(function(t){var i,a;i=new views.ArticleDetailSubjectTagEditor({model:t,articleTags:e}),this._subviews.push(i),a=i.render().el,this.$editSubjectTagsContainer.append(a)},this);var n=this.$el.find("#add-subject-tag").parents(".modal-parent").find(".modal-inner")[0];d3.select(n).call(this.drag())}},subject_tags:{add:function(e){var t,i;return 1==collections.article_detailed_subject_tags.instance.length&&this.$subjectTagsContainer.html(""),t=new views.ArticleDetailSubjectTag({model:e}),this._subviews.push(t),i=t.render().el,this.$subjectTagsContainer.append(i),this},remove:function(e){return 0==collections.article_detailed_subject_tags.instance.length&&this.$subjectTagsContainer.append('<li class="tag empty">None</li>'),e.trigger("destroy"),this}},impact_tags:{add:function(e){var t,i;return t=new views.ArticleDetailImpactTag({model:e}),this._subviews.push(t),i=t.render().el,this.$impactTagsContainer.append(i),this},remove:function(e){return e.set("destroy",!0),this}},impact_tag_attribute:{add:function(e,t){var i,a,s=t.metadata("which"),n={categories:this.$impactTagCategoriesContainer,levels:this.$impactTagLevelsContainer},r=n[s];return i=new views.ArticleDetailAttributeTag({model:e}),this._subviews.push(i),a=i.render().el,r.append(a),this},remove:function(){}},bakeEventCreator:function(){var e={status:"approved",content_items:[{id:this.model.id,title:this.model.get("title")}]},t=new views.EventCreator({el:this.$eventCreator[0],model:e,collection:this.article_detailed_events_collection});return this._subviews.push(t),this._time_picker=t._time_picker,this},filterEventsByDateRange:function(e,t){collections.po.article_detailed_events.filters.timestamp.clearQuery(),t||collections.po.article_detailed_events.filters.timestamp.intersectQuery(e)},setActiveTab:function(){var e=collections.article_detailed.instance.metadata("selected-tab"),t=this.$el.find('.tab[data-group="'+e+'"]'),i=$('.detail-section[data-group="'+e+'"]');return this.$el.find(".tab").removeClass("active"),t.addClass("active"),$(".detail-section").hide(),i.show(),this},setActiveTabFromClick:function(e){var t,i=$(e.currentTarget);return i.hasClass("active")||(t=i.attr("data-group"),collections.article_detailed.instance.metadata("selected-tab",t),this.setActiveTab()),this},setDetailNavigation:function(){var e,t,i,a,s=app.instance.staged_article_comparison_models,n=_.pluck(s,"id"),r=this.model.id,o=n.indexOf(r),l=this.$el.find(".article-detail-navigation"),c=l.find(".prev"),d=l.find(".next"),h=(l.find(".spacer"),o-1),u=o+1;-1!=o&&(o>0&&(e=s[h],i=helpers.templates.htmlDecode(e.get("title")),c.html(" Prev").addClass("go-to-detail").attr("data-id",e.get("id")).attr("aria-label",i).prepend('<span class="octicon octicon-chevron-left"></span>')),o<n.length-1&&(t=s[u],a=helpers.templates.htmlDecode(t.get("title")),d.html("Next ").addClass("go-to-detail").attr("data-id",t.get("id")).attr("aria-label",a).append('<span class="octicon octicon-chevron-right"></span>')))},toggleModal:function(e){views.helpers.toggleModal(e)},destroyView:function(e){this.killView()},drag:function(){return d3.behavior.drag().on("drag",function(e,t){var i=d3.select(this),a=parseInt(i.style("top")),s=parseInt(i.style("left"));a+=d3.event.dy,s+=d3.event.dx,i.style("top",a+"px").style("left",s+"px")})},moreEvents:function(e){return app.helpers.gifizeLoadMoreButton($(e.currentTarget)),this.fetchEventsByParameters(!0),this},setLoadMoreEventsButton:function(){var e,t=this.article_detailed_events_collection,i=this.$eventsGalleryContainer;i.find(".load-more").remove();var a,s=t.metadata("pagination"),n=s.page,r=s.per_page,o=s.total_pages,l=t.length,c=t.metadata("total"),d=o>n,h=c-l,u=_.min([h,r]);return d&&(e=$('<button class="load-more"></button>'),a="Showing "+l+" out of "+c+". Load "+u+" more...",e.html(a).appendTo(i)),this},fetchEventsByParameters:function(e,t){var i=this,a=this.event_filters.assembleQueryParams();a.content_item_ids=this.model.id;var s=this.article_detailed_events_collection,n=s.metadata("pagination")||{},r=n.page;return console.log("params",a),e?a.page=r+1:(i.setLoading.call(i,i.$eventsContainer,!0),s.set([])),s.fetch({data:a,remove:!1}).then(function(e,a,s){t&&i.bakeEventGalleryFurniture(),i.setLoading.call(i,i.$eventsContainer,"false"),i.setLoadMoreEventsButton.call(i)}),this},updateTagContainerByCounts:function(){return _.each(this.tag_list_els,function(e,t){var i=models.event_tag_facets.get(t);console.log(t,i),e.find(".count").html(i.length);var a=i.length>0;e.toggleClass("disabled",!a)},this),this}}),views.ArticleDetailAttributeTag=views.AA_BaseTag.extend({tagName:"li",className:"tag",initialize:function(){return this.styleLayout(),this},render:function(){var e=_.extend(this.model.toJSON(),helpers.templates),t=templates.articleDetailTagFactory(e);return this.$el.html(t),this}}),views.ArticleDetailEvent=Backbone.View.extend({className:"event-container",events:{"click input.destroy":"destroyEvent","submit form":"saveModal"},initialize:function(){this._subviews=[],this.listenTo(this.model,"change:in_selection",this.killView),this.listenTo(this.model,"refresh",this.refresh)},refresh:function(){this.silenceView(),this.render()},render:function(){this.silenceAllSubviews();var e=this.model.toJSON(),t=templates.articleDetailEventFactory(_.extend(e,helpers.templates.articles));return this.$el.html(t),this.$eventTagsContainer=this.$el.find(".event-tags-container"),this.postRender(),this},postRender:function(){return this.bakeTags(),this.bakeEventEditor(),this},bakeTags:function(){var e=this.model.get("impact_tags_full");return e.forEach(function(e){var t=new views.ArticleSummaryDrawerImpactTag({model:e}),i=t.render().el;this._subviews.push(t),this.$eventTagsContainer.append(i)},this),this},bakeEventEditor:function(){var e=new views.EventEditor({el:this.$el,model:this.model.toJSON()});return this._subviews.push(e),this._time_picker=e._time_picker,this.$el.append(e.el),this.event_editor_view=e,this},saveModal:function(e){e.preventDefault();var t=this,i=this.event_editor_view,a=i.getSettings();return i.validateNew(i.full_info.schema,a,function(s,n){s?i.printMsgOnSubmit(s,n):(t.disableBtns(),t.model.save(a,{error:function(e,t,a){console.log("Server error on event edit",t);var s=t.responseJSON;i.printMsgOnSubmit(!0,"Error "+s.status+": "+s.message.replace(/\n/g,"<br/><br/>"))},success:function(a,s,n){t.render(),i.printMsgOnSubmit(!1,""),t.toggleModal(e)}}))},this),this},update:function(e,t){return t||this.killView(),this},destroyEvent:function(e){var t=this;this.model.destroy({success:function(i,a){t.killView(),t.toggleModal(e)},error:function(e){console.log("Error deleting event.",e)}})},toggleModal:function(e){views.helpers.toggleModal(e)},disableBtns:function(){this.event_editor_view.$form.find(".buttons-container").addClass("disabled")}}),views.ArticleDetailImpactTag=views.AA_BaseTag.extend({tagName:"li",className:"tag",initialize:function(){return this.styleLayoutWithTooltip(),this.listenTo(this.model,"change:destroy",this.destroyView),this},render:function(){var e=_.extend(this.model.toJSON(),helpers.templates),t=templates.articleDetailTagFactory(e);return this.$el.html(t),this}}),views.ArticleDetailSubjectTag=views.AA_BaseTag.extend({tagName:"li",className:"tag",initialize:function(){return this.styleLayout(),this.listenTo(this.model,"destroy",this.destroyView),this},render:function(){var e=_.extend(this.model.toJSON(),{toTitleCase:helpers.templates.articles.toTitleCase}),t=templates.articleDetailTagFactory(e);return this.$el.html(t),this},destroyView:function(e){this.killView()}}),views.ArticleDetailSubjectTagEditor=views.AA_BaseTag.extend({tagName:"li",className:"tag",events:{change:"toggleChecked"},initialize:function(e){var t=_.pluck(e.articleTags,"id");return this.model.set("checked",_.contains(t,this.model.id)),this.listenTo(this.model,"change:checked",this.syncToApi),this},render:function(){var e=_.extend({},this.model.toJSON(),helpers.templates.articles),t=templates.articleDetailAccountSubjectTagFactory(e);return this.$el.html(t),this.styleLayout(),this},toggleChecked:function(){var e=this.$el.find("input").prop("checked");this.model.set("checked",e)},syncToApi:function(e,t){var i=this,a=t?"update":"delete",s=collections.article_detailed_subject_tags.instance;this.$el.addClass("disabled"),s.sync(a,e,{success:function(t,a,n){var r=this.type;"DELETE"===r?s.remove(e):"PUT"==r&&s.add(e),i.$el.removeClass("disabled")},error:function(e,t,a){app.instance.reportErr(e,a),i.$el.removeClass("disabled")}})}}),views.ArticleDetailVizArticleReferrers=views.AA_BaseArticleViz.extend({initialize:function(e){var t=e.referrer_metrics,i=e.title,a=e.which;this.section_title=i,this.setMarkup(),this.$el.attr("data-which",a);var s=t.article_referrers;return this.data=s,this},render:function(){var e=this,t=this.$vizContainer.get(0),i=d3.select(t),a=i.selectAll(".bar-container").data(this.data).enter();return a.append("div").classed("bar-text",!0).html(function(t){return'<a href="'+t+'" target="_blank">'+e.ppUrl(t)+"</a>"}),this},ppUrl:function(e){return e=e.replace(/(http|https):\/\//,""),e=e.replace(/[^w{3}\.]([a-zA-Z0-9]([a-zA-Z0-9\-]{0,65}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,6}/i,function(e){return'<span class="highlight">'+e+"</span>"})}}),views.ArticleDetailVizDeviceFacet=views.AA_BaseArticleViz.extend({initialize:function(e){var t=e.referrer_metrics,i=e.title,a=e.which;this.section_title=i,this.setMarkup(),this.calcComparisonMarkerParams(),this.$el.attr("data-which",a),this.listenTo(collections.article_comparisons.instance,"resetMetricHeaders",this.redrawMarker);var s=[{facet:"desktop",pageviews:0},{facet:"tablet",pageviews:0},{facet:"mobile",pageviews:0}],n=t.device_facets,r=t.total.pageviews;return s.forEach(function(e){var t,i=_.findWhere(n,{facet:e.facet});i&&(t=i.pageviews,e.pageviews=t)}),this.data=s,this.total=r,this}}),views.ArticleDetailVizDomainFacets=views.AA_BaseArticleViz.extend({initialize:function(e){var t=e.referrer_metrics,i=e.title,a=e.which;this.section_title=i,this.setMarkup(),this.$el.attr("data-which",a);var s=t.ref_domain_facets,n=t.total.pageviews,r=_.findWhere(t.ref_domain_facets,{facet:"t"});return r&&(r.facet="twitter"),this.data=s.sort(function(e,t){return e.pageviews<t.pageviews?1:-1}),this.total=n,this}}),views.ArticleDetailVizInternalExternal=views.AA_BaseArticleViz.extend({initialize:function(e){var t=e.referrer_metrics,i=e.title,a=e.which;this.section_title=i,this.setMarkup(),this.calcComparisonMarkerParams(),this.$el.attr("data-which",a),this.listenTo(collections.article_comparisons.instance,"resetMetricHeaders",this.redrawMarker);var s=t.total.entrances,n=t.total.pageviews;return this.data=[{facet:"internal",pageviews:n-s},{facet:"external",pageviews:s}],this.total=n,this}}),views.ArticleDetailVizTweets=views.AA_BaseArticleViz.extend({initialize:function(e){var t=e.tweet_info,i=e.title,a=e.which;return this.section_title=i,this.setMarkup(),this.$el.attr("data-which",a),this.data=t,this},render:function(){var e=this.$vizContainer.get(0),t=d3.select(e),i=t.selectAll(".bar-container").data(this.data).enter();return i.append("div").classed("tweet-container",!0).html(function(e){var t=e.html.replace('<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>',"");return t}),setTimeout(function(){window.twttr.widgets.load()},0),this},ppUrl:function(e){return e=e.replace(/(http|https):\/\//,""),e=e.replace(/[^w{3}\.]([a-zA-Z0-9]([a-zA-Z0-9\-]{0,65}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,6}/i,function(e){return'<span class="highlight">'+e+"</span>"})}}),views.ArticleDrawerSorter=Backbone.View.extend({events:{"change select":"setSort","click .sort-direction":"toggleSortDir"},initialize:function(){this.$sorter=this.$el.find("select"),this.$direction=this.$el.find(".sort-direction"),this.render()},render:function(){var e=this.collection.models,t=collections.dimensions.instance.metadata("sort_by"),i=e.map(function(e){var i=e.get("sort_name"),a=i==t||i=="metrics."+t?"selected":"";return'<option value="'+i+'" '+a+">"+helpers.templates.articles.prettyMetricName(e.get("name"))+"</option>"}).join("");this.$sorter.append(i)},setSort:function(){var e=this.$sorter.val(),t=this.$direction.attr("data-dir")||"";models.content_item_filters.set("sort_by",t+e).trigger("filter")},toggleSortDir:function(){var e=this.$direction.attr("data-dir");return e?this.$direction.attr("data-dir",""):this.$direction.attr("data-dir","-"),this.setSort(),this}}),views.ArticleSearcher=Backbone.View.extend({events:{keyup:"listenForKeyup_debounced"},initialize:function(){this.$el.val(""),this.listenForKeyup_debounced=_.debounce(this.listenForKeyup,250)},listenForKeyup:function(e){var t=this.$el.val();return 0!==e.which&&(console.log("search q",t),t?models.content_item_filters.set("q",t):models.content_item_filters.unset("q",t),models.content_item_filters.trigger("filter")),this}}),views.ArticleSummaryDrawer=Backbone.View.extend({tagName:"li",className:"drawer-list-item",events:{"click .drawer-list-outer":"toggleActive"},initialize:function(){this._subviews=[],this.updateActiveSelectionField(),this.listenTo(models.section_mode,"change:mode",this.updateActiveSelectionField),this.listenTo(this.model,"change:active_selected",this.setActiveCssState),this.listenTo(this.model,"change:selected_for_detail",this.setDetailDrawerDisplay),this.listenTo(this.model,"destroy",this.destroy),this.listenTo(this.model,"toggleElement",this.toggleActive)},render:function(){var e=templates.articleSummaryDrawerFactory(_.extend(this.model.toJSON(),helpers.templates));return this.$el.html(e),this.$subjectTagsContainer=this.$el.find(".subject-tags-container"),this.$impactTagsContainer=this.$el.find(".impact-tags-container"),this.addTags(),this.setActiveCssState(),this},updateActiveSelectionField:function(e,t){t=t||models.section_mode.get("mode"),this.selected_for=t},toggleActive:function(){var e=this.selected_for;return"compare"==e?(this.model.toggle("selected_for_"+e),this.model.toggle("active_selected")):"detail"==e&&app.instance.sectionMode.detail.call(app.instance,this.model.get("id")),this},clearRadios:function(e){return collections.article_summaries.instance.filter(function(t){var i=t.get("id");return i!=e}).forEach(function(e){e.set({active_selected:!1,selected_for_detail:!1})}),this},setDetailDrawerDisplay:function(e,t){var i=e.get("id"),a=e.get("active_selected");t&&(this.clearRadios(i),a||this.model.set("active_selected",!0))},setActiveCssState:function(){var e=this.model.get("active_selected");return this.$el.find(".drawer-list-outer").toggleClass("active",e),this.$el.find(".inputs-container input").prop("checked",e),this},addTags:function(){var e=_.uniq(this.model.get("subject_tags_full"),function(e){return e.id}),t=_.uniq(this.model.get("impact_tags_full"),function(e){return e.id});e.length&&(this.$subjectTagsContainer.html('<span class="tag-list-title">Subj:</span>'),e.forEach(function(e){var t=new models.subject_tag.Model(e),i=new views.ArticleSummaryDrawerSubjectTag({model:t}),a=i.render().el;this._subviews.push(i),this.$subjectTagsContainer.append(a)},this)),t.length&&(this.$impactTagsContainer.html('<span class="tag-list-title">Imp:</span>'),t.forEach(function(e){var t=new models.subject_tag.Model(e),i=new views.ArticleSummaryDrawerImpactTag({model:t}),a=i.render().el;this._subviews.push(i),this.$impactTagsContainer.append(a)},this))},destroy:function(e){this.killView()}}),views.ArticleSummaryDrawerImpactTag=views.AA_BaseTag.extend({tagName:"li",className:"tag",initialize:function(){return this.styleLayoutWithTooltip(),this.listenTo(this.model,"change:destroy",this.destroyView),this},render:function(){var e=_.extend(this.model.toJSON(),helpers.templates),t=templates.articleDetailTagFactory(e);return this.$el.html(t),this}}),views.ArticleSummaryDrawerSubjectTag=views.AA_BaseTag.extend({tagName:"li",className:"tag",initialize:function(){return this.styleLayout(),this},render:function(){var e=_.extend(this.model.toJSON(),helpers.templates),t=templates.articleDetailTagFactory(e);return this.$el.html(t),this}}),views.ArticleSummaryRow=Backbone.View.extend({tagName:"div",className:"article-detail-row-wrapper",events:{"click .destroy":"removeRow"},initialize:function(){this.listenTo(this.model,"removeFromComparison",this.destroy),this.listenTo(this.model,"redrawMarker",this.redrawMarker),
this.calcComparisonMarkerParams()},render:function(){var e=this.$el,t=this.model.toJSON(),i=_.extend({selects:this.collection.getSelectDimensions(),calcSize:this.calcSize,comparisonOperation:this.comparison_marker_operation,comparisonMax:this.comparison_marker_max,comparisonGroup:this.comparison_marker_group},t,helpers.templates.articles),a=templates.articleSummaryRowFactory(i),s="",n=0;return this.$el.html(a),this.$el.attr("data-title",t.title).attr("data-created",t.created),_.each(t.metrics,function(t,i){e.attr("data-"+i,t)}),t.subject_tags_full&&(s=_.pluck(t.subject_tags_full,"name").join("")),e.attr("data-subject_tags",s),t.impact_tags_full&&(n=t.impact_tags_full.length),e.attr("data-impact_tags",n),this.model_json=t,this.bullet_markers=d3.select(this.el).selectAll(".marker"),this},calcComparisonMarkerParams:function(){return this.comparison_marker_operation=collections.article_comparisons.instance.metadata("operation"),this.comparison_marker_group=collections.article_comparisons.instance.metadata("group"),this.comparison_marker_max=collections.article_comparisons.instance.metadata("max"),this},redrawMarker:function(){this.calcComparisonMarkerParams();{var e=this;this.bullet_markers.style("left",function(){var t=d3.select(this),i=t.attr("data-metric-name");return e.calcSize.call(e,i,e.comparison_marker_operation,e.comparison_marker_max,e.comparison_marker_group)})}},removeRow:function(){return collections.article_comparisons.instance.remove(this.model),app.instance.saveHash(),this},destroy:function(e,t){return app.instance.$isotopeCntnr&&app.instance.$isotopeCntnr.isotope("remove",this.$el).isotope("layout"),this.killView(),this},calcSize:function(e,t,i,a){a=a||this.comparison_marker_group,i=i||this.comparison_marker_max;var s;s="all"==a?models.comparison_metrics.get(a):models.comparison_metrics.get("subject_tags")[a];var i,n,r,o=_.findWhere(s,{metric:e});return o?(i=o[i],n=d3.scale.linear().domain([0,i]).range([0,100]),"string"==typeof t&&(t=o[t],t||(console.log("ERROR: Missing max comparison value for group",a,"and metric",e,"in field",t),t=0)),r=Math.round(n(t)).toString()+"%"):(console.log("ERROR: Missing comparison values for group",a,"and metric",e),r="0%"),r}}),views.DateRangeSearcher=Backbone.View.extend({events:{"click .clear":"clearDateRange"},pikaday_options:{timezone:pageData.timezone},initialize:function(){var e=this.$el.find("input");e.val(""),this.$clearDateRange=this.$el.find(".clear");var t=this,i=this.$el.find('input[data-dir="after"]'),a=this.$el.find('input[data-dir="before"]'),s={field:i[0],onSelect:function(){var e=this.getDate(),a=this.getMoment(),s=a.format(helpers.templates.prettyDateTimeFormat);t.picker_end.setMinDate(e),t.picker_end.getDate()||t.picker_end.gotoDate(e),i.val(s)},onClose:function(){i.val()||(t.picker_end.setMinDate(),this._d=""),t.filterByDate.call(t)}},n={field:a[0],onSelect:function(){var e=this.getDate(),i=this.getMoment(),s=i.format(helpers.templates.prettyDateTimeFormat);t.picker_start.setMaxDate(e),a.val(s)},onClose:function(){a.val()||(t.picker_start.setMaxDate(),this._d=""),t.filterByDate.call(t)}};_.extend(s,this.pikaday_options),_.extend(n,this.pikaday_options),this.picker_start=new Pikaday(s),this.picker_end=new Pikaday(n),this.$els=e},clearDateRange:function(e){this.picker_start._d="",this.picker_end._d="",this.$els.val(""),$(e.currentTarget).css("visibility","hidden"),this.filterByDate()},assembleValidDates:function(){return[this.picker_start,this.picker_end].map(function(e,t){var i=t?"created_before":"created_after",a=e.getDate();return a&&(a=e.getMoment().format()),{name:i,value:a}})},filterByDate:function(){var e=this.assembleValidDates();e.forEach(function(e){e.value?(models.content_item_filters.set(e.name,e.value),this.$clearDateRange.css("visibility","visible")):models.content_item_filters.unset(e.name,e.value)},this),models.content_item_filters.trigger("filter")}}),views.DivisionSwitcher=Backbone.View.extend({events:{"click li":"setMode"},initialize:function(){this.listenTo(this.model,"change:mode",this.updateActiveState),this.updateActiveState()},setMode:function(e){var t=$(e.currentTarget);if(!t.hasClass("active")){var i=t.attr("data-mode");this.model.set("mode",i)}return this},updateActiveState:function(e,t){return $("#drawer").attr("data-mode",t),$("#content").attr("data-mode",t),this.$el.find("li").removeClass("active"),this.$el.find('li[data-mode="'+t+'"]').addClass("active"),this}}),views.EventCreator=views.AA_BaseForm.extend({events:_.extend({"submit form":"saveModal"},views.AA_BaseForm.prototype.events),initialize:function(e){var t=_.clone(pageData.eventCreatorSchema);this.full_info={schema:t,vals:e.model},e.disableModal?this.$form=this.$el.find("form"):this.bakeModal("Create an event"),this.saveMsg=e.saveMsg||"",this.render(),this.postRender({search:!0,pikaday:!0})},refresh:function(){return this.silenceAllSubviews(),this.render(),this.postRender({search:!0,pikaday:!0}),this.flashSubmitMsg(!1,this.saveMsg),this},render:function(){var e="",t=this.full_info;return _.each(t.schema,function(i,a){e+=this.bakeFormInputRow.call(this,a,i,!1,t.vals[a])},this),e+=this.bakeButtons(),this.$form.html(e),this},saveModal:function(e){e.preventDefault();var t=this,i=this.getSettings();return this.validateNew(this.full_info.schema,i,function(a,s){a?t.printMsgOnSubmit(a,s):(t.toggleBtnsDisabled(),t.printMsgOnSubmit(!1,""),this.collection.create(i,{wait:!0,error:function(e,i,a){console.log("Server error on event edit",i),t.toggleBtnsDisabled(),t.printMsgOnSubmit(!0,"Error "+i.status+": "+i.responseText.replace(/\n/g,"<br/><br/>"))},success:function(i,a,s){console.log(a),t.toggleModal(e),t.refresh()}}))},this),this},toggleBtnsDisabled:function(){this.$form.find(".buttons-container").toggleClass("disabled")},flashSubmitMsg:function(e,t){var i="success";e&&(i="fail"),this.$submitMsgText.removeClass("success").removeClass("fail"),this.$submitMsgText.addClass(i).html(t).delay(7e3).fadeOut(500).delay(750).queue(function(e){$(this).html("").removeClass(i).show(),e()})}}),views.EventCreatorFromAlert=views.AA_BaseForm.extend({initialize:function(e){var t=$.extend(!0,{},pageData.eventCreatorSchema),i=[],a=e.model,s={created:a.created,url:a.url,img_url:a.img_url,content_items:a.content_items,title:a.title,description:a.description,tag_ids:a.tag_ids},n=this.combineFormSchemaWithVals(t,s);_.each(n,function(e,t){e.required&&i.push(t)}),this.form_schema=n,this.full_schema=n,this.required_keys=i,this.bakeModal("Create an event"),this.render(),this.postRender({search:!0,pikaday:!0})},render:function(){var e="",t=$.extend(!0,{},this.form_schema);return _.each(t,function(t,i){e+=this.bakeFormInputRow.call(this,i,t)},this),e+=this.bakeButtons(),this.$form.html(e),this}}),views.EventEditor=views.AA_BaseForm.extend({events:_.extend({},views.AA_BaseForm.prototype.events),initialize:function(e){var t=_.clone(pageData.eventCreatorSchema);delete t.content_items,this.full_info={schema:t,vals:e.model},this.bakeModal("Edit this event"),this.render(),this.postRender({search:!1,pikaday:!0})},render:function(){var e="",t=this.full_info;return _.each(t.schema,function(i,a){e+=this.bakeFormInputRow.call(this,a,i,!1,t.vals[a])},this),e+=this.bakeButtons(!0),this.$form.html(e),this}}),views.RecipeCreator=views.AA_BaseRecipe.extend({events:_.extend({},views.AA_BaseRecipe.prototype.events),initialize:function(e){var t=e.sousChef,i=this.separateSchemaFromEvent(t.options),a=i.settingsInfo,s=i.eventInfo,n=t.slug,r=[];return this.$form=this.$el.find("form"),this.$defaultEvents=this.$el.find(".default-event-container"),a.sous_chef={input_type:"hidden",selected:n,required:!0},delete a.tag_ids,_.each(a,function(e,t){e["default"]&&(e.selected=e["default"]),e.required&&r.push(t)}),this.form_schema=a,this.event_schema=s,this.full_schema=$.extend(!0,{},a,s),this.required_keys=r,this.render(),this.postRender({search:!0}),this.updateScheduleByLayout("minutes"),this},render:function(){var e,t="",i=this.form_schema;_.each(i,function(e,i){t+=this.bakeFormInputRow.call(this,i,e)},this),this.$form.prepend(t);var e=this.renderDefaultEvent();return this.$defaultEvents.html(e),this},renderDefaultEvent:function(){var e="",t=this.event_schema;return _.each(t,function(t,i){e+=this.bakeFormInputRow.call(this,i,t,!0)},this),e}}),views.RecipeDrawer=Backbone.View.extend({tagName:"li",className:"drawer-list-item",events:{"click .drawer-list-outer:not(active)":"filter","click .settings-switch":"toggleModal","click .toggle-default-event":"toggleDefaults","submit form":"saveModal","click .destroy":"destroyModel"},initialize:function(){return this._subviews=[],this.listenTo(this.model,"filter",this.filter),this.listenTo(this.model,"change:viewing",this.setActiveCssState),this.listenTo(this.model,"change:enabled",this.renderEnabled),this.listenTo(this.model,"change:set_default_event",this.showHideDefaults),this},render:function(){this.silenceAllSubviews();var e=templates.recipeFactory(_.extend(this.model.toJSON(),helpers.templates));return this.$el.html(e),this.$form=this.$el.find("form"),this.$defaultEvents=this.$el.find(".default-event-container"),this.$defautEventsBtn=this.$el.find(".toggle-default-event"),this.$submitMsg=this.$el.find(".submit-msg"),this.postRender(),this},postRender:function(){this.bakeRecipeEditor()},bakeRecipeEditor:function(){var e=new views.RecipeEditor({el:this.el,model:this.model.toJSON()});return this._subviews.push(e),this.$el.append(e.el),this.recipe_editor_view=e,this},filter:function(){var e=this.model.id;return app.instance.content.setActiveAlertsPerRecipe.call(app.instance,e),app.instance.show_all_view.deactivate(),this.model.set("viewing",!0),routing.router.navigate("my-recipes/"+e),this},toggleModal:function(e){return this.killEvent(e),views.helpers.toggleModal(e),this},saveModal:function(e){e.preventDefault();var t=this,i=this.recipe_editor_view,a=this.model.get("set_default_event"),s=i.getSettings(a),n=i.required_keys;return this.recipe_editor_view.validate(n,s,function(a,n){a?i.printMsgOnSubmit(a,n):t.model.save(s,{error:function(e,t,a){console.log("Server error on recipe edit",t);var s=t.responseJSON;i.printMsgOnSubmit(!0,"Error "+s.status+": "+s.message.replace(/\n/g,"<br/><br/>"))},success:function(a,s,n){t.render(),i.printMsgOnSubmit(!1,""),t.toggleModal(e)}})},this),this},destroyModel:function(e){var t=this;return this.model.destroy({success:function(i,a,s){t.toggleModal(e),t.$el.remove()},error:function(e,t,i){console.log("error in model destroy",t),alert("Your destroy did not work. Please try again. Check the console for errors.")}}),this},killEvent:function(e){e.stopPropagation()},setActiveCssState:function(e,t){return this.$el.find(".drawer-list-outer").toggleClass("active",t),this.$el.find(".inputs-container input").prop("checked",t),this},toggleDefaults:function(){this.model.set("set_default_event",!this.model.get("set_default_event"))},showHideDefaults:function(e,t){var i=350;t?(this.$defautEventsBtn.html("Enabled").attr("data-status","true"),this.$defaultEvents.slideDown(i,"easeOutQuint")):(this.$defautEventsBtn.html("Disabled").attr("data-status","false"),this.$defaultEvents.slideUp(i,"easeOutQuint"))}}),views.RecipeDrawerStatic=Backbone.View.extend({tagName:"li",className:"drawer-list-item",events:{"click .drawer-list-outer:not(active)":"filter"},initialize:function(){return this._subviews=[],this.listenTo(this.model,"filter",this.filter),this.listenTo(this.model,"change:viewing",this.setActiveCssState),this.listenTo(this.model,"change:enabled",this.renderEnabled),this},render:function(){this._time_picker&&this._time_picker.destroy();var e=templates.recipeStaticFactory(_.extend(this.model.toJSON(),helpers.templates));return this.$el.html(e),this.$form=this.$el.find("form"),this},filter:function(){var e=this.model.id;return app.instance.content.setActiveAlertsPerRecipe.call(app.instance,e),app.instance.show_all_view.deactivate(),this.model.set("viewing",!0),routing.router.navigate("my-recipes/manual"),this},killEvent:function(e){e.stopPropagation()},setActiveCssState:function(e,t){return this.$el.find(".drawer-list-outer").toggleClass("active",t),this.$el.find(".inputs-container input").prop("checked",t),this}}),views.RecipeEditor=views.AA_BaseRecipe.extend({events:_.extend({"click .modal-outer":"stopPropagation"},views.AA_BaseRecipe.prototype.events),initialize:function(e){var t=this.separateSchemaFromEvent(e.model.options),i=t.settingsInfo,a=t.eventInfo,s=[],n=collections.sous_chefs.instance.findWhere({slug:e.model.sous_chef}).get("options"),r=this.separateSchemaFromEvent(n),o=r.settingsInfo,l=r.eventInfo,c=_.extend({name:{input_type:"text",selected:e.model.name,required:!0}},this.combineFormSchemaWithVals(o,i));_.each(c,function(e,t){e.required&&s.push(t)});var d=this.combineFormSchemaWithVals(l,a);return this.form_schema=c,this.event_schema=d,this.full_schema=$.extend(!0,{},c,d),this.required_keys=s,this.$form=this.$el.find("form"),this.$defaultEvents=this.$el.find(".default-event-container"),this.render(),this.postRender({search:!0}),this.updateScheduleByLayout(),this},render:function(){var e,t="",i=this.form_schema;return _.each(i,function(e,i){t+=this.bakeFormInputRow.call(this,i,e)},this),this.$form.prepend(t),e=this.renderDefaultEvent(),this.$defaultEvents.html(e),this},renderDefaultEvent:function(){var e="",t=this.event_schema;return _.each(t,function(t,i){e+=this.bakeFormInputRow.call(this,i,t,"default_event")},this),e},stopPropagation:function(e){return e.stopPropagation(),this}}),views.SettingFacebookPage=views.AA_BaseSettingListItemRecipe.extend({initialize:function(e){return this.default_model_opts={sous_chef:"facebook-page-to-event",name:app.defaults.staff_facebook_page_to_promotion_recipe_name,options:{search_query:pageData.org.homepage},validate:function(e){return e.options.search_query?void 0:"You must supply a homepage for this recipe to be valid"}},this.options=e,this.render(),this.checkIfNew(),this.initializeBase(),this.setVals(["options[page_name]"]),this.postRender(),this}}),views.SettingImpactTag=views.AA_BaseSetting.extend({tagName:"li",initialize:function(){return this.render(),this.checkIfNew(),this.initializeBase(),this.setVals(["name","color","category","level"]),this.initColorPicker("impact-tag"),this.postRender(),this},checkIfNew:function(){return this.model||(this.model=new models.impact_tag.Model({}),collections.impact_tags.instance.add(this.model),this.$el.find(".js-parent-form").attr("data-new","true")),this},render:function(){var e=templates.impactTagFactory({});return this.$el.html(e),this}}),views.SettingPassword=views.AA_BaseSetting.extend({initialize:function(e){this.options=e,this.initializeBase();var t=this.getPasswordEl("old"),i=this.getPasswordEl("new"),a=this.getPasswordEl("confirm");return this.fields=[t,i,a],this.listenTo(this.model,"change:data_needs_correction",this.setDataCorrection),this.model.set("patch",!0),this.postRender(),this},inputHasChanged:function(e){e.preventDefault(),e.stopPropagation();var t,i=13,a=27;return e.keyCode==i?this.saveModel(e):e.keyCode==a?this.revertToPreviousSettingVal(e):(t=this.getCurrentFormData(),this.model.set("input_val",t),this.compareFormData()),this},getPasswordEl:function(e){return this.$form.find('input[type="password"][data-which="'+e+'"]')},setDataCorrection:function(e,t){return this.$form.attr("data-needs-correction",t.toString()),this},compareFormData:function(){var e=this.getPasswordEl("old").val(),t=this.getPasswordEl("new").val(),i=this.getPasswordEl("confirm").val(),a=e&&t&&t===i;(e||t||i)&&this.flagErrors();var s=(t||i)&&t!=i?!0:!1;return this.flagErrors(this.getPasswordEl("confirm"),s),this.model.set("data_changed",a),this},revertToPreviousSettingVal:function(){return this.model.set("data_changed","false"),this.model.set("data_inputted","false"),this.fields.forEach(function(e){e.val("")}),!0},flagErrors:function(e,t){e?e.toggleClass("js-needs-correction",t):this.fields.forEach(function(e){var t=e.val().trim(),i=""==t;e.toggleClass("js-needs-correction",i)})}}),views.SettingRssFeed=views.AA_BaseSettingListItemRecipe.extend({initialize:function(e){return this.default_model_opts={sous_chef:"rss-feed-to-article",name:app.defaults.rss_feed_recipe_name},this.options=e,this.render(),this.checkIfNew(),this.initializeBase(),this.setVals(["options[feed_url]"]),this.postRender(),this}}),views.SettingSingle=views.AA_BaseSetting.extend({initialize:function(e){return this.options=e,this.render(),this.initializeBase(),this.setVals(),this.postRender(),this},render:function(){var e=this.options.template||this.template,t=this.options.parentEl||this.parentEl;return e&&(this.$el.html(e({})),t&&$(t).append(this.el)),this},postSaveHook:function(){var e=["homepage","timezone"];e.forEach(function(e){var t=this.model.get("name"),i=this.model.get("value");e==t&&(pageData.org[e]=i)},this),pageData.org.homepage&&pageData.org.timezone&&$("#promotion").attr("data-required-fields-set","true")}}),views.SettingStaffTwitterList=views.AA_BaseSettingListItemRecipe.extend({initialize:function(e){return this.default_model_opts={sous_chef:"twitter-list-to-event",name:app.defaults.staff_twitter_list_to_promotion_recipe_name,options:{search_query:pageData.org.homepage},validate:function(e){return e.options.search_query?void 0:"You must supply a homepage for this recipe to be valid"}},this.options=e,this.render(),this.checkIfNew(),this.initializeBase(),this.setVals(["options[list_owner_screen_name]","options[list_slug]"]),this.postRender(),this}}),views.SettingSubjectTag=views.AA_BaseSetting.extend({tagName:"li",initialize:function(){return this.render(),this.checkIfNew(),this.initializeBase(),this.setVals(["name","color"]),this.initColorPicker("subject-tag"),this.postRender(),this},checkIfNew:function(){return this.model||(this.model=new models.subject_tag.Model({}),collections.subject_tags.instance.add(this.model),this.$el.find(".js-parent-form").attr("data-new","true")),this},render:function(){var e=templates.subjectTagFactory({});return this.$el.html(e),this}}),views.SettingTwitterUser=views.AA_BaseSettingListItemRecipe.extend({initialize:function(e){return this.default_model_opts={sous_chef:"twitter-user-to-event",name:app.defaults.staff_twitter_user_to_promotion_recipe_name,options:{search_query:pageData.org.homepage},validate:function(e){return e.options.search_query?void 0:"You must supply a homepage for this recipe to be valid"}},this.options=e,this.render(),this.checkIfNew(),this.initializeBase(),this.setVals(["options[screen_name]"]),this.postRender(),this}}),views.ShowAllRecipes=Backbone.View.extend({tagName:"div",className:"drawer-container",events:{"click .drawer-list-outer:not(.active)":"setState"},initialize:function(){},render:function(e){var t=templates.drawerMyRecipesPrepFactory({hasRecipes:e});return this.$el.html(t),this.styleLayout(!0),this},setState:function(){this.styleLayout(!0),this.filter()},styleLayout:function(e){collections.recipes.instance.where({viewing:!0}).forEach(function(e){e.set("viewing",!1)}),this.$el.find(".drawer-list-outer").toggleClass("active",e),this.$el.find(".inputs-container input").prop("checked",e)},filter:function(){app.instance.content.setActiveAlertsPerRecipe.call(app.instance,"all"),routing.router.navigate("my-recipes")},deactivate:function(){this.styleLayout(!1)}}),views.SousChefDrawerItem=Backbone.View.extend({tagName:"li",className:"drawer-list-item",initialize:function(){return this},render:function(){var e=templates.sousChefDrawerItemFactory(_.extend(this.model.toJSON(),helpers.templates));return this.$el.html(e),this}}),views.SousChefForm=Backbone.View.extend({tagName:"div",className:"article-detail-wrapper mode-content",events:{"click .toggle-default-event":"toggleDefaults","submit form":"save"},initialize:function(){return this._subviews=[],this.listenTo(this.model,"change:destroy",this.destroy),this.listenTo(this.model,"change:set_default_event",this.showHideDefaults),this},render:function(){var e=templates.sousChefFormFactory(_.extend(this.model.toJSON(),helpers.templates));return this.$el.html(e).attr("data-mode","create-new"),this.$form=this.$el.find("form"),this.$defaultEvents=this.$el.find(".default-event-container"),this.$defautEventsBtn=this.$el.find(".toggle-default-event"),this.$submitMsg=this.$el.find(".submit-msg"),this.model.get("set_default_event")&&(this.$defaultEvents.show(),this.showHideDefaults()),this.postRender(),this},postRender:function(){return this.bakeRecipeCreator(),this},bakeRecipeCreator:function(){var e=new views.RecipeCreator({el:this.el,sousChef:this.model.toJSON()});return this._subviews.push(e),this.$el.append(e.el),this.event_creator_view=e,this},save:function(e){e.preventDefault();var t=this,i=this.event_creator_view,a=this.model.get("set_default_event"),s=i.getSettings(a),n=new models.recipe_creator.Model,r=i.required_keys;this.event_creator_view.validate(r,s,function(e,r){e?i.printMsgOnSubmit(e,r):n.save(s,{error:function(e,t,a){var s=t.responseJSON;i.printMsgOnSubmit(!0,"Error "+s.status+": "+s.message.replace(/\n/g,"<br/><br/>"))},success:function(e,i,s){t.render(),t.flashSubmitMsg(!1,"Recipe saved!");var n=i.id;e.set("event_counts",null),e.set("set_default_event",a),e.set("id",n),collections.recipes.instance.add(e,{at:0})}})},this)},flashSubmitMsg:function(e,t){var i="success";e&&(i="fail"),this.$submitMsg.removeClass("success").removeClass("fail"),this.$submitMsg.addClass(i).html(t).delay(7e3).fadeOut(500).delay(750).queue(function(e){$(this).html("").removeClass(i).show(),e()})},toggleDefaults:function(){this.model.set("set_default_event",!this.model.get("set_default_event"))},showHideDefaults:function(){var e=this.model.get("set_default_event"),t=350;e?(this.$defautEventsBtn.html("Enabled").attr("data-status","true"),this.$defaultEvents.slideDown(t,"easeOutQuint")):(this.$defautEventsBtn.html("Disabled").attr("data-status","false"),this.$defaultEvents.slideUp(t,"easeOutQuint"))}}),views.Tag=views.AA_BaseTag.extend({tagName:"li",className:"tag-wrapper",events:{click:"toggle"},initialize:function(){this.listenTo(this.model,"change:active",this.styleLayout)},render:function(){var e=templates.tagFactory(_.extend(this.model.toJSON(),helpers.templates));return this.$el.html(e),this.updateLayoutByCount(),this.styleLayout(),this.hasInitialized=!0,this},styleLayout:function(){var e=this.model.get("active")||!1,t=this.model.get("color"),i="auto",a="auto";return this.$el.find(".tag-container").css("border-left-color",t),e&&(i=t,a=this.whiteOrBlack(i)),this.$el.toggleClass("active",e),this.$el.find(".tag-container").css({"background-color":i,color:a}),this},toggle:function(){return this.model.toggle("active"),this},updateLayoutByCount:function(){var e=this.getCount(),t=e>0;return this.setCount(e),this.hasInitialized?this.$el.toggleClass("disabled",!t):this.$el.toggle(t),this},setCount:function(e){return this.$el.find(".tag-count").html(e),this}}),views.TagEventFilter=views.Tag.extend({initialize:function(e){views.Tag.prototype.initialize.call(this),this.listenTo(this.model,"change:active",this.setOpts),this.listenTo(models.event_tag_facets,"change",this.updateLayoutByCount),this.filterModel=e.filterModel},setOpts:function(e,t){var i=this.getImportantModelInfo(),a=i.group,s=_.values(i.id_key_value)[0],n=this.filterModel,r=n.get(a)||[];return"tags"==a&&(a="tag_ids"),t?r.push(s):r=_.without(r,s),r.length?n.set(a,r):n.unset(a),n.trigger("filter"),this},getImportantModelInfo:function(){var e=this.model.collection.metadata("filter"),t=this.model.toJSON(),i=_.pick(t,"id");return/_tag_ids/.test(e)&&(e="tags"),_.isEmpty(i)&&(i=_.pick(t,"name")),{id_key_value:i,group:e}},getCount:function(){var e=this.getImportantModelInfo(),t=e.group,i={},a={categories:"category",levels:"level"};a[t]?i[a[t]]=_.values(e.id_key_value)[0]:i=e.id_key_value;var s=models.event_tag_facets.get(t),n=_.findWhere(s,i)||{count:0};return n.count}}),views.TagSectionNav=views.Tag.extend({initialize:function(){views.Tag.prototype.initialize.call(this),this.listenTo(this.model,"change:active",this.setOpts),this.listenTo(models.tag_facets,"change",this.updateLayoutByCount)},setOpts:function(e,t){var i=this.getImportantModelInfo(),a=i.group,s=_.values(i.id_key_value)[0];/_tags/.test(a)&&(a="tag_ids");var n=models.content_item_filters.get(a)||[];return t?n.push(s):n=_.without(n,s),n.length?models.content_item_filters.set(a,n):models.content_item_filters.unset(a),models.content_item_filters.trigger("filter"),this},getImportantModelInfo:function(){var e=this.model.collection.metadata("filter"),t=this.model.toJSON(),i=_.pick(t,"id");return/_tag_ids/.test(e)&&(e=e.replace("_tag_ids","_tags")),_.isEmpty(i)&&(i=_.pick(t,"name")),{id_key_value:i,group:e}},getCount:function(){var e=this.getImportantModelInfo(),t=e.group,i={},a={categories:"category",levels:"level"};a[t]?i[a[t]]=_.values(e.id_key_value)[0]:i=e.id_key_value;var s=models.tag_facets.get(t),n=_.findWhere(s,i)||{count:0};return n.count}}),views.helpers={toggleModal:function(e){e.preventDefault(),e.stopPropagation(),console.log("toggling");var t=$(e.currentTarget).parents(".modal-parent"),i=t.find(".modal-outer");i.toggleClass("active",!i.hasClass("active")),$("body").attr("data-modal",i.hasClass("active")),t.attr("data-modal-open",i.hasClass("active")),this.centerishInViewport(i.find(".modal-inner"))},centerishInViewport:function(e){var t=e.outerWidth(),i=e.outerHeight(),a=$(window).width(),s=$(window).height();e.css({top:_.max([4,(s/2-i/2)/s*100-10])+"%",left:(a/2-t/2)/a*100+"%"})}},views.po={},routing={Router:Backbone.Router.extend({initialize:function(e){this.history=[],this.listenTo(this,"route",function(e,t){_.isUndefined(t[1])||this.history.push({name:e,mode:t[0],ids:t[1],fragment:Backbone.history.fragment})}),routing.init[e].call(this),routing.init.common.call(this)},loadRecipesAlerts:function(e,t){"manual"==t&&(t=-1),t=+t,app.instance.pause_init=!0,this.setModeOnly(e),collections.recipes.instance.findWhere({id:t}).trigger("filter")},setModeOnly:function(e){models.section_mode.set("mode",e)},compareArticles:function(e,t,i){app.instance.pause_init=!0;"compare"==models.section_mode.get("mode");e=e.replace(/\+/g,",");var a="true"===i?"":"-",s=_.pluck(collections.dimensions.instance.cloneMetrics(),"name"),n=_.contains(s,t)?"metrics.":"",r={ids:e,sort:a+n+t};models.section_mode.set("mode","compare"),collections.article_comparisons.instance.fetch({data:r},{merge:!0}).then(function(e,t,i){app.instance.pause_init=!1,app.instance.staged_article_comparison_models=collections.article_comparisons.instance.models,app.instance.saveHash()})},detailArticle:function(e){var t="detail"==models.section_mode.get("mode");e=+e,t?app.instance.detail.loadPage.call(app.instance,e,app.instance.saveHash):(app.instance.staged_article_detail=e,models.section_mode.set("mode","detail"))}}),helpers:{getMode:function(e){return e.split("/")[0].replace(/#/g,"")},getArticleIds:function(e){return e.split("/")[1]},exists:function(e,t){var i=new RegExp(t);return i.test(e)}}},templates.init={articles:function(){this.tagFactory=_.template($("#tag-templ").html()),this.articleSummaryDrawerFactory=_.template($("#article-summary-drawer-templ").html()),this.drawerPointers=$("#drawer-pointers-templ").html(),this.articleGridContainerFactory=_.template($("#article-grid-container-templ").html()),this.articleSummaryRowFactory=_.template($("#article-summary-row-templ").html()),this.articleDetailFactory=_.template($("#article-detail-templ").html()),this.articleDetailEventFactory=_.template($("#article-detail-event-templ").html()),this.articleDetailTagFactory=_.template($("#article-detail-tag-templ").html()),this.articleDetailAccountSubjectTagFactory=_.template($("#article-detail-account-subject-tag-templ").html())},"approval-river":function(){this.drawerMyRecipesPrepFactory=_.template($("#drawer-my-recipes-templ").html()),this.drawerCreatePrep=$("#drawer-create-templ").html(),this.alertFactory=_.template($("#alert-templ").html()),this.recipeFactory=_.template($("#recipe-templ").html()),this.recipeStaticFactory=_.template($("#recipe-static-templ").html()),this.sousChefDrawerItemFactory=_.template($("#sous-chef-drawer-item-templ").html()),this.sousChefFormFactory=_.template($("#sous-chef-form-templ").html())},settings:function(){this.inputActionsFactory=_.template($("#input-actions-templ").html()),this.subjectTagFactory=_.template($("#subject-tag-templ").html()),this.impactTagFactory=_.template($("#impact-tag-templ").html()),this.rssFeedRecipeFactory=_.template($("#rss-feed-templ").html()),this.staffTwitterListRecipeFactory=_.template($("#staff-twitter-feed-templ").html()),this.twitterUserRecipeFactory=_.template($("#twitter-user-templ").html()),this.facebookPageRecipeFactory=_.template($("#facebook-page-templ").html()),this.modalFactory=_.template($("#modal-templ").html())},submit:function(){}},models.init={articles:function(){this.tag_facets=new models.generic.Model(pageData.tags.facets),this.content_item_filters=new models.filters.Model({sort_by:pageData.articleSummariesInfo.sort_by}),this.comparison_metrics=new models.generic.Model(pageData.comparisonMetrics),this.section_mode=new models.generic.Model,this.section_mode.compare={}},"approval-river":function(){this.section_mode=new models.generic.Model},settings:function(){this.org.instance=new this.org.Model(pageData.org)},submit:function(){}},collections.init={articles:function(){this.subject_tags.instance=new this.subject_tags.Collection(pageData.tags.subject),this.subject_tags.instance.metadata("filter","subject_tag_ids"),this.impact_tags.instance=new this.impact_tags.Collection(pageData.tags.impact),this.impact_tags.instance.metadata("filter","impact_tag_ids"),this.impact_tag_attributes.categories_instance=new this.impact_tag_attributes.Collection(pageData.tags.categories),this.impact_tag_attributes.levels_instance=new this.impact_tag_attributes.Collection(pageData.tags.levels),this.impact_tag_attributes.categories_instance.metadata("filter","categories"),this.impact_tag_attributes.levels_instance.metadata("filter","levels"),this.dimensions.instance=new this.dimensions.Collection(pageData.dimensionsInfo.dimensions),this.dimensions.instance.metadata("sort_by",pageData.dimensionsInfo.sort_by),this.article_summaries.instance=new this.article_summaries.Collection(pageData.articleSummariesInfo.response,{parse:!0}),this.article_comparisons.instance=new this.article_comparisons.Collection([]),collections.article_comparisons.instance.metadata("sort_by",pageData.dimensionsInfo.sort_by),collections.article_comparisons.instance.metadata("sort_ascending",pageData.dimensionsInfo.sort_ascending),this.articles_detailed.instance=new this.articles_detailed.Collection,this.article_detailed.instance=new this.article_detailed.Collection,this.article_detailed.instance.metadata("selected-tab","life"),this.article_detailed_subject_tags.instance=new this.article_detailed_subject_tags.Collection,this.article_detailed_impact_tags.instance=new this.article_detailed_impact_tags.Collection,this.article_detailed_impact_tag_attributes.categories_instance=new this.article_detailed_impact_tag_attributes.Collection,this.article_detailed_impact_tag_attributes.categories_instance.metadata("which","categories"),this.article_detailed_impact_tag_attributes.levels_instance=new this.article_detailed_impact_tag_attributes.Collection,this.article_detailed_impact_tag_attributes.levels_instance.metadata("which","levels")},"approval-river":function(){var e={id:-1,name:"Manually created",event_counts:{pending:pageData.manualEventsTotal},sous_chef:"manual-event",created:(new Date).toString()};pageData.recipes.push(e),this.recipes.instance=new this.recipes.Collection(pageData.recipes),this.sous_chefs.instance=new this.sous_chefs.Collection(pageData.sousChefs),this.loaded_alerts.recipe_all_instance=new this.loaded_alerts.Collection(pageData.eventsInfo.events),this.loaded_alerts.recipe_all_instance.metadata("pagination",pageData.eventsInfo.pagination),this.loaded_alerts.recipe_all_instance.metadata("total",pageData.eventsInfo.total),
this.active_alerts.instance=new this.active_alerts.Collection([])},settings:function(){this.user_settings.instance=new this.user_settings.Collection([pageData.user]),this.settings.instance=new this.settings.Collection(pageData.orgSettingsList),this.recipes.instance=new this.recipes.Collection(pageData.recipes.all),this.subject_tags.instance=new this.subject_tags.Collection(pageData.tags.subject),this.impact_tags.instance=new this.impact_tags.Collection(pageData.tags.impact)},submit:function(){this.impact_tags.instance=new this.impact_tags.Collection(pageData.tags.impact)}},app.init={articles:function(){this.instance=new this.Articles},"approval-river":function(){this.instance=new this.ApprovalRiver},settings:function(){this.defaults=pageData.defaultRecipeNames,this.instance=new this.Settings},submit:function(){var e=new collections.article_detailed_events.Collection;this.instance=new this.Submit({collection:e})}},routing.init={go:function(e){this.router=new this.Router(e),Backbone.history.start()},common:function(){this.starting_route&&this.route("",function(){routing.router.navigate(this.starting_route,{trigger:!0})})},articles:function(){this.route(":mode","setModeOnly"),this.route("compare/:ids?sort=:sort_by&asc=:asc","compareArticles"),this.route("detail/:id","detailArticle"),this.starting_route="compare"},"approval-river":function(){this.route(":mode","setModeOnly"),this.route(":mode/:id","loadRecipesAlerts"),this.starting_route="my-recipes"},settings:function(){},submit:function(){}};var init={go:function(){var e=$("body").attr("data-section");templates.init[e].call(templates),models.init[e].call(models),collections.init[e].call(collections),app.init[e].call(app),routing.init.go.call(routing,e)}};init.go();
//# sourceMappingURL=main.bundled.js.map